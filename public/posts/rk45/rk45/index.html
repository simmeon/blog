<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blog/livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>An Engineer&#39;s Guide to the Runge-Kutta (RK45) Method | simmeon&#39;s blog</title>
<meta name="keywords" content="runge kutta, ode, numerical integration, rk45, python">
<meta name="description" content="Understanding what the RK45 method is, a complete derivation, and applying it to engineering problems.">
<meta name="author" content="simmeon">
<link rel="canonical" href="https://simmeon.github.io/blog/post/rk45.md">
<link crossorigin="anonymous" href="/blog/assets/css/stylesheet.54405a410796490bc874ab6181fac9b675753cc2b91375d8f882566459eca428.css" integrity="sha256-VEBaQQeWSQvIdKthgfrJtnV1PMK5E3XY&#43;IJWZFnspCg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/blog/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/blog/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/blog/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/blog/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/blog/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/blog/posts/rk45/rk45/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="An Engineer&#39;s Guide to the Runge-Kutta (RK45) Method" />
<meta property="og:description" content="Understanding what the RK45 method is, a complete derivation, and applying it to engineering problems." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/blog/posts/rk45/rk45/" />
<meta property="og:image" content="http://localhost:1313/blog/images/papermod-cover.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-05-18T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-05-18T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/blog/images/papermod-cover.png" />
<meta name="twitter:title" content="An Engineer&#39;s Guide to the Runge-Kutta (RK45) Method"/>
<meta name="twitter:description" content="Understanding what the RK45 method is, a complete derivation, and applying it to engineering problems."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/blog/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "An Engineer's Guide to the Runge-Kutta (RK45) Method",
      "item": "http://localhost:1313/blog/posts/rk45/rk45/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "An Engineer's Guide to the Runge-Kutta (RK45) Method",
  "name": "An Engineer\u0027s Guide to the Runge-Kutta (RK45) Method",
  "description": "Understanding what the RK45 method is, a complete derivation, and applying it to engineering problems.",
  "keywords": [
    "runge kutta", "ode", "numerical integration", "rk45", "python"
  ],
  "articleBody": "\rThe Initial Value Problem In engineering, we often encounter systems that evolve over time, such as circuits, mechanical systems, or chemical reactions. These systems are best described using differential equations. For example, Newton’s law of cooling states:\n$$ \\dfrac{dT}{dt} = -k(T - T_{surr}) $$\nwhere T is the temperature of some point, k is a proportionality constant, and Tsurr is the temperature surrounding the point of interest.\nTo solve this equation is to find a solution for the temperature, T, over time. In this case, this is fairly straightforward and we can come up with an analytical solution of the form:\n$$ T(t) = T_{surr} + (T(0) - T_{surr})e^{-kt} $$\nNotice that the solution depends on the initial temperature, as Figure 1 shows. We need a point of reference to define the solution that is relevant to our system.\nFigure 1: Temperature of a point over time with different initial temperatures. Tsurr = 20 C, k = 1.\nFigure 1 code\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 ''' Plotting the temperature of a point with different starting temperatures. Created by: simmeon Last Modified: 28/04/24 License: MIT ''' import matplotlib.pyplot as plt import numpy as np # Define system parameters T_surr = 20 # surrounding temperature of 20 C k = 1 # proportionality constant of 1 for simplicity # Define our cooling function def solve_T(t, T0): return T_surr + (T0 - T_surr)*np.exp(-k*t) # Create an array of times from 0-5 seconds t = np.arange(0, 5, 0.1) # Solve and plot the solutions for different initial values of T T0_choices = [30, 25, 20, 15, 10] plt.style.use('https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle') for T0 in T0_choices: T = solve_T(t, T0) plt.plot(t, T, label='T0 = {} C'.format(T0)) plt.title('Temperature over time', fontsize=20) plt.xlabel('Time [s]', fontsize=20) plt.ylabel('Temperature [C]', fontsize=20) plt.xlim(0, 5) plt.ylim(10, 30) plt.grid(alpha=0.7) plt.legend() plt.show() The initial value problem deals with solving these ordinary differential equations where we have an initial state of the system, eg. the initial temperature is 25 C. However, often these systems are hard or impossible to solve analytically. To solve them, we use numerical methods to approximate the solution. Let’s look at how we might be able to do that…\nNumerical Methods Let’s take the previous cooling equation,\n$$ \\dfrac{dT}{dt} = -k(T - T_{surr}) $$\nand assume we can’t find an analytical solution. Let’s consider the information we do have that could help us approximate the solution. We have an expression for the derivative that we can calculate at any time, t, assuming we know the current temperature at that time. We know the temperature at some initial time (t = 0 in this case), so we can calculate the derivative at that time. But how does this help us find the temperature at other times?\nThe Euler Method From calculus we know that we get the derivative of a function by taking two points on the function and approximating the derivative as if it were a striaght line. As the distance, h, between the two points gets closer to 0, the approximation gets better. Formally,\n$$ f^{\\prime}(x) = \\lim_{h \\rightarrow 0} \\frac{f(x+h) - f(x)}{h} $$\nWe can rearrange this and assume a finite step size, h, to get\n$$ f(x+h) \\approx f(x) + h f^{\\prime}(x) $$\nwhich gives us an expression to approximate the next step of a function using only the current known function value and the function derivative. We can see what this looks like with different step sizes in Figure 2.\nFigure 2: Estimating the value of y = x2 with different step sizes.\nFigure 2 code\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 ''' Visualising how the derivative can be used to estimate the value of a function. Created by: simmeon Last Modified: 28/04/24 License: MIT ''' import matplotlib.pyplot as plt import numpy as np plt.style.use('https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle') # Define some function we want to find the value of def func(t): return t**2 # Define the derivative line of the function def dydt(t, t0, y0): m = 2 * t0 return m * (t-t0) + y0 # Create an array of time values to plot the function t_func = np.arange(0.5, 2, 0.1) # Estimation parameters t0 = 1.0 # known initial value y0 = func(t0) # known initial value h = [1, 0.5, 0.2] # step size options # Plotting # Find and plot function values y_func = func(t_func) plt.plot(t_func, y_func) plt.plot(t0, y0, 'x', color='C0') # Plot the derivative line for each step size colours = ['C1', 'C2', 'C3'] for i in range(len(h)): t_dydt = np.arange(t0, t0 + h[i], 0.1) y_dydt = dydt(t_dydt, t0, y0) plt.plot(t_dydt, y_dydt, color=colours[i], label='Step = {:.1f}'.format(h[i])) plt.plot(t_dydt[-1], y_dydt[-1], 'o', color=colours[i]) # Show plot plt.title(\"Estimating a function by using the derivative\", fontsize=20) plt.legend(loc='lower right', fontsize=10) plt.show() This is Euler’s method for solving the initial value problem. We might also write it as:\n$$ f_{k+1} \\approx f_{k} + h f^{\\prime}(x_{k}) $$\nfor some index, k.\nWe can iterate through time with this method, using the newly found fk+1 as our new fk and so on. In code, that would look like the following:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 def euler(dydt, y0, t0, t_end, h=0.1): ''' Takes the derivative function, an initial condition, the time we want to integrate until, and a step size. Returns arrays of time and y values. ''' t = np.arange(t0, t_end+h, h) y = np.zeros(len(t)) y[0] = y0 for i in range(1,len(t)): y[i] = y[i-1] + h * dydt(y[i-1]) return t, y The highlighted line shows the Euler method itself where the next value of the function is estimated.\nLet’s try do that with Newton’s cooling law and see how the result compares to the analytical solution. Figure 3 shows what that would look like.\nFigure 3: Analytical and Euler method solutions to Newton’s cooling law. Tsurr = 20 C, k = 1.\nFigure 3 code\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 ''' Performing Euler integration to solve the cooling equation. We will compare with the analytical solution. Created by: simmeon Last Modified: 28/04/24 License: MIT ''' import matplotlib.pyplot as plt import numpy as np plt.style.use('https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle') # Define system T_surr = 20 # surrounding temperature of 20 C k = 1 # proportionality constant of 1 for simplicity # Define our cooling function def solve_T(t, T0): return T_surr + (T0 - T_surr)*np.exp(-k*t) # Define the derivative (only depends on the current temp, not time) def dTdt(T): return -k * (T - T_surr) # Define our Euler integration function def euler(dTdt, T0, t0, t_end, h=0.1): ''' Takes the derivative function, an initial condition, the time we want to integrate until, and a step size. Returns arrays of time and temperature values ''' t = np.arange(t0, t_end+h, h) T = np.zeros(len(t)) T[0] = T0 for i in range(1,len(t)): T[i] = T[i-1] + h * dTdt(T[i-1]) return t, T # Parameters t0 = 0 T0 = 30 t_end = 5 # Get analytical solution t_analytical = np.arange(t0, t_end+0.1, 0.1) T_analytical = solve_T(t_analytical, T0) # Get Euler numerical solution t_euler_05, T_euler_05 = euler(dTdt, T0, t0, t_end, 0.5) t_euler_01, T_euler_01 = euler(dTdt, T0, t0, t_end, 0.1) # Plotting plt.plot(t_analytical, T_analytical, label='Analytical', linestyle='--') plt.plot(t_euler_05, T_euler_05, label='Euler method, h = 0.5') plt.plot(t_euler_01, T_euler_01, label='Euler method, h = 0.1') plt.title(\"Analytical and Euler method solutions to Newton's cooling law\", fontsize=20) plt.xlabel('Time [s]', fontsize=20) plt.ylabel('Temperature [C]', fontsize=20) plt.legend(fontsize=15) plt.show() It is clear that the step size plays a big role in the accuracy of the solution. We could continue to reduce the step size, but that will quickly increase the time it takes to get a solution beyond a reasonable amount. Maybe we can think of a better way of doing this…\nRunge-Kutta Methods A major problem with Euler’s method is that using the derivative of the point we’re at is not very good at estimating the next value of the function (for the kind of step sizes we want to use). The derivative is constantly changing and could be vastly different at the new value. We might get a more accurate step if we use a mix of the derivative at our start point and end point.\nThis is the basis for how Runge-Kutta methods work. We find derivatives between the start and end points of each step and use a weighted average of those as the actual derivative for the step. The simplest version of this would be to just use the derivative at the start of the step – which is exactly the Euler method! The Euler method is a 1st order Runge-Kutta method.\nLet’s define the method more concretely.\nDerivation of Runge-Kutta Methods We will start by examining the initial problem again, being that we want to solve the following general equation for y:\n$$ \\dfrac{dy}{dt} = f(y, t) $$\nThis could be our cooling equation from before,\n$$ \\dfrac{dT}{dt} = -k(T - T_{surr}) $$\nor something more complex like a state space defining a spring, mass, damper system:\n$$ \\bold{\\dot{x}} = \\begin{bmatrix} 0 \u0026 1 \\\\ \\frac{-k}{m} \u0026 \\frac{-c}{m} \\end{bmatrix} \\bold{x} + \\begin{bmatrix} 0 \\\\ \\frac{1}{m} \\end{bmatrix} u(t) $$\nIn both cases, we are given the derivative of the state we want to solve for (eg. temperature) and the derivative depends on the value of the state and time. In the case of the cooling equation, the derivative only depends on the state, T, and not time.\nIdeally, we could just integrate the derivative to find the value at \\( t + h \\):\n$$ y(t+h) = y(t) + \\int_{\\tau=t}^{\\tau=t+h}{\\dfrac{dy(\\tau)}{d\\tau}} d\\tau $$\nHowever, as we said earlier, this is often hard or impossible. We can instead approximate the integral with a weighted sum.\nWeighted Sum Approximations Let’s build this up slowly. Take the following function, for example:\n$$ f(t) = t^3 - 2t^2 - t + 3 $$\nHow would we evaluate\n$$ \\int_0^2{f(t)}dt $$\nWe can do this analytically, which is like summing up tiny vertical slices of the function to find the total area underneath it. But we could think about this a different way. We can get that same area by finding the average value of the function over the interval, then multiplying by the length of the interval. You can see this in Figure 4.\nFigure 4: Comparison of areas found by integration and weighted sum approximation.\nFigure 4 code\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 ''' Making sense of weighted sums as integral approximations. Created by: simmeon Last Modified: 28/04/24 License: MIT ''' import matplotlib.pyplot as plt import numpy as np plt.style.use('https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle') def f(t): return t**3 -2*t**2 - t + 3 # Perform a weighted sum approximation N = 10 # higher number of samples, N, gives a better approximation sum = 0 t0 = 0 h = 2 nodes = np.linspace(t0, t0+h, N) for node in nodes: sum += f(node) weighted_sum = sum / N print('Weighted sum area: ', weighted_sum * h) # Plotting t = np.arange(t0, t0 + h, 0.01) y = f(t) # Integration result plt.subplot(1,2,1) plt.plot(t,y) plt.fill_between(t, y, alpha=0.3) plt.annotate('Area = 2.67', (1,2.5), fontsize=20) plt.title('Area from integration', fontsize=20) # Weighted sum result plt.subplot(1,2,2) plt.plot(t,y) plt.fill_between(t, weighted_sum, alpha=0.3) plt.annotate('Area = {:.2f}'.format(weighted_sum * h), (1,2.5), fontsize=20) plt.title('Area from weighted sum', fontsize=20) plt.show() To put this idea into an equation, we can say:\n$$ \\int_0^2{f(t)}dt \\approx \\frac{2}{\\sum{w_i}} \\sum_{i=1}^N{w_i f(t_i)} $$\nWhere \\( N \\) is the number of points we sample from the function to find the average, \\( w_i \\) is the weighting we give to each point, and \\( t_i \\) is some point inside the integration bounds of \\( [0, 2] \\). We can simplify this by giving every point a weighting of 1:\n$$ \\int_0^2{f(t)}dt \\approx \\frac{2}{N} \\sum_{i=1}^N{f(t_i)} $$\nThe more points we sample, the closer the average will be to the actual average of the function and therefore the actual integral.\nWe can extend this concept to our derivative from earlier:\n$$ \\int_{\\tau=t}^{\\tau=t+h}{\\dfrac{dy(\\tau)}{d\\tau}} d\\tau \\approx \\frac{h}{\\sum{w_i}} \\sum_{i=1}^N{w_i y^{\\prime}(t+v_i h, y(t+v_i h))} $$\nWhat a mess.\nWe’re still using the same concept of a weighted sum to find the average value of the derivative function, but since the derivative depends on \\( t \\) and \\( y \\) it’s a bit more complicated. We introduced \\( v_i \\) to help define which values of the function we sample, also called nodes. This can range from 0 to 1 to cover the interval from \\( t \\) to \\( t+h \\). Of course, whatever time we evaluate our derivative at must be the same time we use to get the \\( y \\) values for the derivative.\nFor the sake of simplicity let’s say that all our weights will sum up to 1. We are not, however, going to assume that all our weights will be the same value as we did previously.\nConsidering all this, the equation we are trying to solve is now:\n$$ y(t+h) = y(t) + h \\sum_{i=1}^N{w_i y^{\\prime}(t+v_i h, y(t+v_i h))} $$\nThe Runge-Kutta Family You might have noticed there is a problem with the sum we just defined. In particular, we don’t know what \\( y(t+v_i h) \\) is. In fact, finding this is basically the point of the whole method. So how do we deal with this?\nSimply, we are going to make worse approximations of \\( y(t+v_i h) \\) so that we can make a much better approximation of \\( y(t + h) \\). Again, these \\( y(t+v_i h) \\) values are used to find values of the derivative that we will then average. Let’s define what we will do to find these approximations.\nWe will start by saying that \\( v_1 = 0 \\). This means the first term in the sum will be\n$$ w_1 y^{\\prime}(t, y(t)) $$\nIf this was the only term in our sum (so \\( w_1 = 1 \\) ), then the equation we would be solving would be:\n$$ y(t+h) \\approx y(t) + h y^{\\prime}(t, y(t)) $$\nThis should look familiar, it’s the Euler method! This is what we mean by the Euler method is a 1st order Runge-Kutta method – because it uses one term in the weighted sum. Or in other words, it is a linear approximation.\nFor simplicity, we will write this first sum term as:\n$$ k_1 = y^{\\prime}(t, y(t)) h $$\n\\( k_1 \\) is a 1st order estimate of the change in \\( y \\) between \\( y(t) \\) and \\( y(t+h) \\).\nThe second term gets trickier as we have to somehow estimate \\( y(t+v_2 h) \\). Conveniently, we have just found an estimate for how \\( y \\) changes: \\( k_1 \\). So we can utilise some fraction of this change to create our estimate for the second weighted sum term where:\n$$ y^{\\prime}(t + \\alpha_2 h, y(t) + \\beta_{2,1} k_1) $$\nWe don’t know yet how much of \\( k_1 \\) we should add, we will figure that out later. Same with what time we should sample at.\nWe have changed notation slightly to help set up higher order Runge-Kutta methods. Instead of \\( v_i \\) we are now using \\( \\alpha_i \\) to tell us about what time we are sampling at. And since our \\( y \\) value is no longer defined in simple terms of time, we are going to use \\( \\beta_{i,j} \\) to describe how much of previous estimates we will add to the estimate for the new term.\nWe define\n$$ k_2 = y^{\\prime}(t + \\alpha_2 h, y(t) + \\beta_{2,1} k_1) h $$\nso that the equation we are solving is now:\n$$ y(t+h) \\approx y(t) + w_1 k_1 + w_2 k_2 $$\nWith that, we have defined the 2nd order Runge-Kutta Method!\nWe can continue the weighted sum with a third and fourth term, following similar logic of using the previous estimates to inform the new value of \\( y(t + v_i h) \\). This will give us:\n$$ k_3 = y^{\\prime}(t + \\alpha_3 h, y(t) + \\beta_{3,1} k_1 + \\beta_{3,2} k_2) h \\\\ k_4 = y^{\\prime}(t + \\alpha_4 h, y(t) + \\beta_{4,1} k_1 + \\beta_{4,2} k_2 + \\beta_{4,3} k_3) h $$\nThis gives the 4th order Runge-Kutta method:\n$$ y(t+h) \\approx y(t) + w_1 k_1 + w_2 k_2 + w_3 k_3 + w_4 k_4 $$\nNow to actually solve these higher order methods, we need to define these coefficients…\nDefining Coefficients We need to define all the \\( \\alpha_i \\), \\( \\beta_{i,j} \\), and \\( w_i \\) coefficients to be able to use these methods. We can do this by comparing the Taylor series expansion of our approximation to the Taylor series expansion of \\( y(t+h) \\) and equating coefficients. Let’s do this for the 2nd order method:\n$$ y(t+h) \\approx y(t) + w_1 k_1 + w_2 k_2 $$\nAs this is a 2nd order method, we will need to find the 2nd order expansions of the left and right sides.\nLet’s start with the left. The 2nd order Taylor series expansion of \\( y(t+h) \\) about \\( t \\) is:\n$$ y(t+h) \\approx y(t) + h \\dfrac{dy}{dt} \\Big| _{t,y} + \\frac{h^2}{2} \\dfrac{d^2y}{dt^2} \\Big| _{t,y} + O(h^3) $$\nWe can write our derivative:\n$$ \\dfrac{dy}{dt} = f(t, y) \\\\ {} \\\\ \\dfrac{d^2y}{dt^2} = \\dfrac{df(t,y)}{dt} = \\dfrac{\\partial f}{\\partial t} + \\dfrac{\\partial f}{\\partial y} \\dfrac{dy}{dt} = \\dfrac{\\partial f}{\\partial t} + f \\dfrac{\\partial f}{\\partial y} $$\nThis makes our left hand side (using slightly different notation):\n$$ y_{n+1} \\approx y_n + h f(t_n, y_n) + \\frac{h^2}{2} \\bigg(\\dfrac{\\partial f}{\\partial t} + f \\dfrac{\\partial f}{\\partial y}\\bigg) \\bigg|_{t_n, y_n} + O(h^3) $$\nGreat! Let’s do the right hand side now. We can write the right hand same with the same notation as above:\n$$ y_n + w_1 k_{1,n} + w_2 k_{2,n} $$\n\\( k_2 \\) is a bit tricky to expand. Our \\( k_2 \\) term is made up mostly of a function with the form \\( f(t + \\Delta t, y + \\Delta y) \\), which will need to be expanded. In general, the 2nd order expansion looks like:\n$$ f(t + \\Delta t, y + \\Delta y) = f(t, y) + \\Delta t \\dfrac{\\partial f}{\\partial t}\\bigg| _{t, y} + \\Delta y \\dfrac{\\partial f}{\\partial y} \\bigg| _{t, y} + O(h^3) $$\nApplying this to \\( k_2 \\) gives:\n$$ k_{2,n} = h f(t + \\alpha_2 h, y_n + \\beta_{2,1} k_1) \\approx h \\bigg( f(t_n, y_n) + \\alpha _2 h \\dfrac{\\partial f}{\\partial t} \\bigg| _{t_n, y_n} + \\beta _{2,1} k_1 \\dfrac{\\partial f}{\\partial y} \\bigg| _{t_n, y_n} \\bigg) $$\nAll together, the right hand side is then\n$$ y_n + w_1 k_{1,n} + w_2 k_{2,n} \\approx y_n + w_1 h f(t_n, y_n) + w_2 h \\bigg( f(t_n, y_n) + \\alpha _2 h \\dfrac{\\partial f}{\\partial t} \\bigg| _{t_n, y_n} + \\beta _{2,1} k_1 \\dfrac{\\partial f}{\\partial y} \\bigg| _{t_n, y_n} \\bigg) + O(h^3) $$\nwhich we can rearrange to be in the same form (substituting in for \\( k_1 \\)) as the left hand side:\n$$ y_n + w_1 k_{1,n} + w_2 k_{2,n} \\approx y_n + (w_1 + w_2) h f(t_n, y_n) + \\frac{h^2}{2} \\bigg(2 w_2 \\alpha_2 \\dfrac{\\partial f}{\\partial t} + 2 w_2 \\beta _{2,1} f \\dfrac{\\partial f}{\\partial y} \\bigg) \\bigg| _{t_n, y_n} + O(h^3) $$\nFinally, we have both expansions and can equate the coefficients:\n$$ y(t+h) \\approx y(t) + w_1 k_1 + w_2 k_2 \\\\ {} \\\\ \\big\\downarrow \\\\ {} \\\\ y_n + h f(t_n, y_n) + \\frac{h^2}{2} \\bigg(\\dfrac{\\partial f}{\\partial t} + f \\dfrac{\\partial f}{\\partial y}\\bigg) \\bigg|_{t_n, y_n} + O(h^3) \\\\ {} \\\\ = \\\\ {} \\\\ y_n + (w_1 + w_2) h f(t_n, y_n) + \\frac{h^2}{2} \\bigg(2 w_2 \\alpha_2 \\dfrac{\\partial f}{\\partial t} + 2 w_2 \\beta _{2,1} f \\dfrac{\\partial f}{\\partial y} \\bigg) \\bigg| _{t_n, y_n} + O(h^3) $$\nFrom this, we can see that our coefficients must satisfy the following equations:\n$$ w_1 + w_2 = 1 \\\\ {} \\\\ w_2 \\alpha_2= \\frac{1}{2} \\\\ {} \\\\ w_2 \\beta_{2,1} = \\frac{1}{2} $$\nWith 3 equations and 4 unknows, there are infinitely many solutions. However, the standard choices are:\n$$ \\alpha_2 = \\beta_{2,1} = 1 \\\\ {} \\\\ w_1 = w_2 = \\frac{1}{2} $$\nThis brings us finally to the complete 2nd order Runge-Kutta Method:\n$$ k_1 = h y^\\prime (t_n, y_n) \\\\ {} \\\\ k_2 = h y^\\prime (t_n + h, y_n + k_1) \\\\ {} \\\\ y_{n+1} = y_n + \\frac{1}{2} k_1 + \\frac{1}{2} k_2 $$\nA similar (messier) method of expansions can be used to for higher order methods. The standard terms for the 4th order Runge-Kutta method are:\n$$ k_1 = h y^\\prime (t_n, y_n) \\\\ {} \\\\ k_2 = h y^\\prime (t_n + \\frac{h}{2}, y_n + \\frac{k_1}{2}) \\\\ {} \\\\ k_3 = h y^\\prime (t_n + \\frac{h}{2}, y_n + \\frac{k_2}{2}) \\\\ {} \\\\ k_4 = h y^\\prime (t_n + h, y_n + k_3) \\\\ {} \\\\ y_{n+1} = y_n + \\frac{1}{6} (k_1 + 2 k_2 + 2 k_3 + k_4) $$\nKeep in mind that there are infinitely many choices of these coefficients and lots of research has gone into figuring out which ones work best. We will stick to these simple standard ones for now.\nImplementing Runge-Kutta Now that we have finally derived the Runge-Kutta methods, let’s implement them in code. We will do both the 2nd order and 4th order methods and compare their accuracy.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 def rk2(dydt, t0, y0, t_end, h): \"\"\" Solves a first-order ODE using the 2nd order Runge-Kutta method Args: dydt: The derivative function to integrate t0: Initial value of time y0: Initial value of y t_end: Final time for integration h: Step size Returns: An array of y values for each time step \"\"\" t = np.arange(t0, t_end+h, h) # Array of time points y = np.zeros_like(t) y[0] = y0 for i in range(1, len(t)): k1 = h * dydt(t[i - 1], y[i - 1]) k2 = h * dydt(t[i - 1] + h, y[i - 1] + k1) y[i] = y[i - 1] + (k1 + k2) / 2 return y We can see how, at each time step, we calculate the \\( k_i \\) values and use these to estimate the next value of the function.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 def rk4(dydt, t0, y0, t_end, h): \"\"\" Solves a first-order ODE using the 4th order Runge-Kutta method Args: dydt: The derivative function to integrate t0: Initial value of time y0: Initial value of y t_end: Final time for integration h: Step size Returns: An array of y values for each time step \"\"\" t = np.arange(t0, t_end+h, h) y = np.zeros_like(t) y[0] = y0 for i in range(1, len(t)): k1 = h * dydt(t[i - 1], y[i - 1]) k2 = h * dydt(t[i - 1] + h / 2, y[i - 1] + k1 / 2) k3 = h * dydt(t[i - 1] + h / 2, y[i - 1] + k2 / 2) k4 = h * dydt(t[i], y[i - 1] + k3) y[i] = y[i - 1] + (k1 + 2 * k2 + 2 * k3 + k4) / 6 return y After all that derivation, the actual method is remarkably clean and simple to implement. Figure 5 gives an idea of how these higher order functions perform compared to our original Euler method.\nFigure 5: Comparing the accuracy of different order ODE solvers, h = 0.1\nAll the solvers are using the same step size here. As we can see, the 4th order method is better than the 2nd order method. They are both much more accurate than the 1st order Euler method.\nAs a final comparison, let’s look at Newton’s law of cooling one last time. Figure 6 shows how our 4th order solver compares to our previous test with the Euler method.\nFigure 6: Comparing the accuracy of the RK4 and Euler methods on the cooling equation. Tsurr = 20 C, k = 1, h = 0.5\nFigure 5 and 6 code\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 ''' Implementing and comparing the Runge-Kutta 2nd and 4th order methods. We can also compare to the Euler method (1st order). Created by: simmeon Last Modified: 29/04/24 License: MIT ''' import matplotlib.pyplot as plt import numpy as np plt.style.use('https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle') # Define some functions to test our solvers with def dydt(t, y): return 3 * t**2 + 20 * np.cos(10 * t) def analytical_solution(t): return t**3 + 2 * np.sin(10 * t) # Analytical solution to the ODE # # Define our cooling function # def solve_T(t, T0): # return T_surr + (T0 - T_surr)*np.exp(-k*t) # # Define the derivative (only depends on the current temp, not time) # def dTdt(T): # return -k * (T - T_surr) def euler_solver(dydt, t0, y0, t_end, h): \"\"\" Solves a first-order ODE using the Euler method Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y t_end: Final time for integration h: Step size Returns: An array of y values for each time step \"\"\" t = np.arange(t0, t_end+h, h) y = np.zeros_like(t) y[0] = y0 for i in range(1, len(t)): y[i] = y[i - 1] + h * dydt(t[i - 1], y[i - 1]) return y def rk2(dydt, t0, y0, t_end, h): \"\"\" Solves a first-order ODE using the 2nd order Runge-Kutta method Args: dydt: The derivative function to integrate t0: Initial value of time y0: Initial value of y t_end: Final time for integration h: Step size Returns: An array of y values for each time step \"\"\" t = np.arange(t0, t_end+h, h) # Array of time points y = np.zeros_like(t) y[0] = y0 for i in range(1, len(t)): k1 = h * dydt(t[i - 1], y[i - 1]) k2 = h * dydt(t[i - 1] + h, y[i - 1] + k1) y[i] = y[i - 1] + (k1 + k2) / 2 return y def rk4(dydt, t0, y0, t_end, h): \"\"\" Solves a first-order ODE using the 4th order Runge-Kutta method Args: dydt: The derivative function to integrate t0: Initial value of time y0: Initial value of y t_end: Final time for integration h: Step size Returns: An array of y values for each time step \"\"\" t = np.arange(t0, t_end+h, h) y = np.zeros_like(t) y[0] = y0 for i in range(1, len(t)): k1 = dydt(t[i - 1], y[i - 1]) k2 = dydt(t[i - 1] + h / 2, y[i - 1] + k1 / 2) k3 = dydt(t[i - 1] + h / 2, y[i - 1] + k2 / 2) k4 = dydt(t[i], y[i - 1] + k3) y[i] = y[i - 1] + (k1 + 2 * k2 + 2 * k3 + k4) / 6 * h return y # Define simulation parameters t0 = 0 y0 = 0 t_end = 5 h = 0.1 # Solve using both methods y_euler = euler_solver(dydt, t0, y0, t_end, h) y_rk2 = rk2(dydt, t0, y0, t_end, h) y_rk4 = rk4(dydt, t0, y0, t_end, h) # Get analytical solution t = np.arange(t0, t_end+h, h) # Array of time points y_analytical = analytical_solution(t) # Calculate errors error_euler = np.abs(y_euler - y_analytical) error_rk2 = np.abs(y_rk2 - y_analytical) error_rk4 = np.abs(y_rk4 - y_analytical) # Plot the numerical solutions plt.subplot(1,2,1) plt.plot(t, y_euler, label='Euler') plt.plot(t, y_rk2, label='RK2') plt.plot(t, y_rk4, label='RK4') plt.plot(t, y_analytical, label='Analytical', linestyle='--') plt.xlabel('Time (t)', fontsize=20) plt.ylabel('y(t)', fontsize=20) plt.title('Numerical Solutions', fontsize=20) plt.legend(fontsize=15) # Plot the errors plt.subplot(1,2,2) plt.plot(t, error_euler, label='Euler') plt.plot(t, error_rk2, label='RK2') plt.plot(t, error_rk4, label='RK4') plt.xlabel('Time (t)', fontsize=20) plt.ylabel('Abs Error', fontsize=20) plt.title('Absolute Errors of the Numerical Solutions', fontsize=20) plt.legend(fontsize=15) plt.show() Even with a relatively large step size, the 4th order method is still much better than the Euler method. In fact, we could make the step size even bigger and still have a solution that fell within some tiny tolerance.\nBut how can we choose a good value to make this step size? If we want to be as efficient as possible, each step would as large as it can be while staying within the tolerance we want…\nStep Sizing Constant Step Size Issues Take the following function,\n$$ y = \\sin{(t^5)} \\\\ {} \\\\ \\dfrac{dy}{dt} = 5t^4 \\cos{(t^5)} $$\nWe can use the derivative to solve for \\( y \\) using one of our numerical methods from earlier. Figure 7 shows us doing this using the Euler method, along with the error in our solution.\nFigure 7: Euler method solution and error using a constant step size, h = 0.05.\nFigure 7 code\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 ''' Seeing how a constant step size numerical solver can have wildly varying error on diffrent steps. Created by: simmeon Last Modified: 18/05/24 License: MIT ''' import matplotlib.pyplot as plt import numpy as np plt.style.use('https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle') # Define function and its derivative def dydt(t, y): return 5*t**4 * np.cos(t**5) def analytical_solution(t): return np.sin(t**5) # Our Euler numerical solver def euler_solver(dydt, t0, y0, t_end, h): \"\"\" Solves a first-order ODE using the Euler method Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y t_end: Final time for integration h: Step size Returns: An array of y values for each time step \"\"\" t = np.arange(t0, t_end+h, h) y = np.zeros_like(t) y[0] = y0 for i in range(1, len(t)): y[i] = y[i - 1] + h * dydt(t[i - 1], y[i - 1]) return t, y # Define simulation parameters t0 = 0 y0 = 0 t_end = 2 h = 0.05 # we are using a constant step size here # Numerically integrate t_euler, y_euler = euler_solver(dydt, t0, y0, t_end, h) # Get analytical solution t_analytical = np.arange(t0, t_end+h, 0.001) y_analytical = analytical_solution(t_analytical) # Get error y_analytical_sampled = y_analytical[0:-1:50] error = np.abs(y_euler - y_analytical_sampled) # Plotting plt.subplot(2,1,1) plt.plot(t_analytical, y_analytical, label='Analytical', linestyle='-') plt.plot(t_euler, y_euler, label='Euler method') plt.title(\"Error when integrating with a constant step size\", fontsize=20) plt.ylabel('y', fontsize=20) plt.legend(fontsize=15) plt.subplot(2,1,2) plt.plot(t_euler, error) plt.ylabel(\"absolute error\", fontsize=20) plt.xlabel('t', fontsize=20) plt.show() The method works well initially when the function is changing slowly. However, when the function is changing more rapidly, our Euler method solver error gets large. You can try increasing the time to integrate over and see how the error becomes even bigger.\nThis is happening because our step size (\\( h = 0.05 \\)) becomes too large to properly capture how the function is changing. We could make our step size smaller, but we don’t need that additional resolution for the start of the function, it’s already pretty accurate.\nUsing Multiple Step Sizes Instead of decreasing the step size for the entire integration period, it would be much more efficient if we could just decrease it where we need to.\nIn this example, we could try switching to a smaller step size (say, \\( h = 0.01 \\)) after \\( t = 1 \\) when our solution starts getting less accurate. Doing this gives the solution shown in Figure 8.\nFigure 8: Euler method solution and error using two step sizes: t \u003c= 1, h = 0.05; t \u003e 1, h = 0.01\nFigure 8 code\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 ''' Seeing how we can improve our solution and efficiency by using two different step sizes at different times. Created by: simmeon Last Modified: 18/05/24 License: MIT ''' import matplotlib.pyplot as plt import numpy as np plt.style.use('https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle') # Define function and its derivative def dydt(t, y): return 5*t**4 * np.cos(t**5) def analytical_solution(t): return np.sin(t**5) # Our Euler numerical solver def euler_solver(dydt, t0, y0, t_end, h): \"\"\" Solves a first-order ODE using the Euler method Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y t_end: Final time for integration h: Step size Returns: An array of y values for each time step \"\"\" t = np.arange(t0, t_end+h, h) y = np.zeros_like(t) y[0] = y0 for i in range(1, len(t)): y[i] = y[i - 1] + h * dydt(t[i - 1], y[i - 1]) return t, y # Define simulation parameters t0 = 0 y0 = 0 t_end1 = 1 t_end2 = 2 h1 = 0.05 # first, bigger step size h2 = 0.01 # second. smaller step size # Numerically integrate t_euler1, y_euler1 = euler_solver(dydt, t0, y0, t_end1, h1) t_euler2, y_euler2 = euler_solver(dydt, t_end1, y_euler1[-1], t_end2, h2) y_euler = np.concatenate((y_euler1, y_euler2)) t_euler = np.concatenate((t_euler1, t_euler2)) # Get analytical solution t_analytical = np.arange(t0, t_end2+h2, 0.001) y_analytical = analytical_solution(t_analytical) # Get error y_analytical_compare = analytical_solution(t_euler) error = np.abs(y_euler - y_analytical_compare) # Plotting plt.subplot(2,1,1) plt.plot(t_analytical, y_analytical, label='Analytical', linestyle='-') plt.plot(t_euler, y_euler, label='Euler method') plt.vlines(t_end1, -1, 1, colors='white', alpha=0.5) plt.title(\"Error when integrating with two different step sizes\", fontsize=20) plt.ylabel('y', fontsize=20) plt.legend(fontsize=15) plt.subplot(2,1,2) plt.plot(t_euler, error) plt.vlines(t_end1, 0, 0.5, colors='white', alpha=0.5) plt.ylabel(\"absolute error\", fontsize=20) plt.xlabel('t', fontsize=20) plt.show() This has made our solution around an order of magnitude more accurate. But how much computational complexity have we saved compared to just solving the entire time interval with the smaller step size? We can summarize this in Table 1.\nTable 1\nStep size Number of iteration steps \\( h = 0.05 \\) 41 \\( t \\leq 1, h = 0.05 \\\\ t\u003e1, h = 0.01\\) 122 \\( h = 0.01 \\) 201 So we are saving a significant amount of computation compared to making the whole interval have a smaller step size.\nChoosing to make the step size smaller at \\( t = 1 \\) was very arbitrary. We could also change the step size in more places – maybe making it even bigger initially and even smaller for \\( t \u003e 1.5 \\). We should come up with a smart way of choosing when and how to change the step size.\nAdaptive Step Sizing Since we want our solution to be accurate, it would be smart to decrease our step size when our error is getting too big. Also, to keep things efficient, we could make our step size bigger when the error is very small.\nThe issue is we don’t have the actual solution, so how can we know what our error is?\nWe need to create some sort of “true solution” to compare our estimate against. One way we could do this is to use a higher order method, since we know that these should be more accurate and be closer to the actual solution. For example, if we want to use a 1st order Euler solver, we could also calculate a 2nd order Runge-Kutta solution and use that as the “true solution”.\nSo for every step, we will calculate the next step with two methods: a lower and higher order one. Then, we will use difference in these as our approximation of the error. From that, we can decide whether we should change the step size for the step or if it was ok.\nThe last thing to decide is how much we should change the step size. For now, a simple approach could be to halve the step size if the error was too big, and double it if it was too small.\nMore formally, we will:\nTake a step with the current step size using a 1st and 2nd order method. Compare the solutions to approximate our error. If the \\( error \u003e tol \\), reject the step, halve the step size, and go back to Step 1. If the \\( error \u003c tol \\), accept the step and double the step size for the next step. In code this would look like:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 def euler_solver(dydt, t0, y0, t_end, tol): \"\"\" Solves a first-order ODE using the Euler method with adaptive step sizing. Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y t_end: Final time for integration tol: Error tolerance Returns: Arrays of y and t values for each time step \"\"\" h = 0.1 # set some initial step size t = [t0] y_euler = [y0] y_rk2 = [y0] i = 1 while t[-1] \u003c t_end: # Take a Euler step y_euler.append(euler_step(dydt, t[i-1], y_euler[i-1], h)) t.append(t[i-1] + h) # Take a RK2 step, starting from the previous Euler step value y_rk2.append(rk2_step(dydt, t[i-1], y_euler[i-1], h)) isStepGood = False error = np.abs(y_rk2[i] - y_euler[i]) if error \u003c tol: # accept step, make step size bigger for next step isStepGood = True h = h * 2 while not isStepGood: # Take a step with both methods y_euler[i] = euler_step(dydt, t[i-1], y_euler[i-1], h) t[i] = t[i-1] + h y_rk2[i] = rk2_step(dydt, t[i-1], y_euler[i-1], h) # Calculate the error between the methods error = np.abs(y_rk2[i] - y_euler[i]) # Check error to accept or reject the step if error \u003e tol: # reject step, halve step size h = h / 2 else: # accept step, make step size bigger for next step isStepGood = True h = h * 2 i += 1 return t, y_euler If we use this to solve the same function as before, we get the solution shown in Figure 9.\nFigure 9: Euler method solution and error with an adaptive step size, tol = 0.01.\nFigure 9 code\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 ''' Implementing an adaptive step size by doubling or halving the step size depending on the error. Created by: simmeon Last Modified: 18/05/24 License: MIT ''' import matplotlib.pyplot as plt import numpy as np plt.style.use('https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle') # Define function and its derivative def dydt(t, y): return 5*t**4 * np.cos(t**5) def analytical_solution(t): return np.sin(t**5) def euler_step(dydt, t0, y0, h): \"\"\" Takes a single 1st order integration step and returns the y value. Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y h: Step size Returns: The y value after the step. \"\"\" y = y0 + h * dydt(t0, y0) return y def rk2_step(dydt, t0, y0, h): \"\"\" Takes a single 2nd order integration step and returns the y value. Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y h: Step size Returns: The y value after the step. \"\"\" k1 = h * dydt(t0, y0) k2 = h * dydt(t0 + h, y0 + k1) y = y0 + (k1 + k2) / 2 return y # Our adaptive Euler numerical solver def euler_solver(dydt, t0, y0, t_end, tol): \"\"\" Solves a first-order ODE using the Euler method with adaptive step sizing. Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y t_end: Final time for integration tol: Error tolerance Returns: Arrays of y, t and local error values for each time step \"\"\" h = 0.1 # set some initial step size t = [t0] y_euler = [y0] y_rk2 = [y0] error = [0] i = 1 while t[-1] \u003c t_end: # Take a Euler step y_euler.append(euler_step(dydt, t[i-1], y_euler[i-1], h)) t.append(t[i-1] + h) # Take a RK2 step, starting from the previous Euler step value y_rk2.append(rk2_step(dydt, t[i-1], y_euler[i-1], h)) isStepGood = False error.append(np.abs(y_rk2[i] - y_euler[i])) if error[i] \u003c tol: # accept step, make step size bigger for next step isStepGood = True h = h * 2 while not isStepGood: # Take a step with both methods y_euler[i] = euler_step(dydt, t[i-1], y_euler[i-1], h) t[i] = t[i-1] + h y_rk2[i] = rk2_step(dydt, t[i-1], y_euler[i-1], h) # Calculate the error between the methods error[i] = np.abs(y_rk2[i] - y_euler[i]) # Check error to accept or reject the step if error[i] \u003e tol: # reject step, halve step size h = h / 2 else: # accept step, make step size bigger for next step isStepGood = True h = h * 2 i += 1 return t, y_euler, error # Define simulation parameters t0 = 0 y0 = 0 t_end = 2 tol = 1e-2 # Numerically integrate t_euler, y_euler, local_error = euler_solver(dydt, t0, y0, t_end, tol) t_euler = np.array(t_euler) y_euler = np.array(y_euler) # Get analytical solution t_analytical = np.arange(t0, t_end, 0.001) y_analytical = analytical_solution(t_analytical) # Get error y_analytical_compare = analytical_solution(t_euler) error = np.abs(y_euler - y_analytical_compare) # Plotting plt.subplot(3,1,1) plt.plot(t_analytical, y_analytical, label='Analytical', linestyle='-') plt.plot(t_euler, y_euler, label='Euler method') plt.scatter(t_euler, y_euler, s=30, marker='o', facecolors='none', color='C1') plt.title(\"Integrating with a adaptive step size, tol = 0.01\", fontsize=20) plt.ylabel('y', fontsize=20) plt.legend(fontsize=15) plt.text(0, -0.75, f\"Number of steps: {len(t_euler)}\", fontsize=15) plt.subplot(3,1,2) plt.plot(t_euler, error) plt.ylabel(\"absolute error\", fontsize=20) plt.xlabel('t', fontsize=20) plt.subplot(3,1,3) plt.plot(t_euler, local_error) plt.ylabel(\"local step error\", fontsize=20) plt.xlabel('t', fontsize=20) plt.show() Each dot represents where a step was taken. We can see how the step size is bigger when the function is changing slowly and smaller when the function changes quickly.\nThe error is interesting. We set a tolerance of \\( 0.01 \\) but the absolute error gets up to nearly \\( 0.1 \\). This is because the tolerance is used to set the allowable error for each step, not the overall (or global) error. Another reason is that our error is an estimate but here we are plotting against the actual, analytical error. Howveer, looking at the local error for each step we can see that it never gets above our tolerance.\nChoosing Better Step Size Changes We used a very simple method of halving the step size if the error was too big or doubling the step size if the error was too small. For the 255 steps we ended up with, the method calculated the next step 746 times. This means that, on average for each step, we changed the step size 2.9 times before finding a value that worked. There is a lot of computation that is wasted there.\nLet’s try and come up with a better way of choosing the step size to hopefully make our method more efficient.\nThis will depend on what order methods we are using.\nWe will start by doing this for the 1st order Euler method. We write this as:\n$$ y_{n+1} = y_{n} + h \\dfrac{dy}{dt} \\bigg| _{t_n, y_n} + O(h^2) $$\nThe error in our estimate is proportional to \\( h^2 \\). If we assume that this error is constant over time, we can say\n$$ error = \\Delta = c h^2 $$\nwhere \\( c \\) is some constant value. Then, for some step size, \\( h_1 \\), we would get\n$$ \\Delta _1 = c h_1^2 $$\nWe could also write an equation for what the step size would have to be to get an error equal to our tolerance. Let’s call this error \\( \\Delta _0 \\).\n$$ \\Delta _0 = c h_0^2 $$\nThis \\( h_0 \\) is the value that we would want to use for the current step size to. In other words, it will give the largest step that stays within our tolerance.\nWe can use these two equations together through the constant \\( c \\) to get the relation:\n$$ \\frac{\\Delta_1}{h_1^2} = \\frac{\\Delta_0}{h_0^2} $$\nThis can then be arranged to solve for what our step size \\( h_0 \\) should be\n$$ h_0 = h_1 \\bigg(\\frac{\\Delta _0}{\\Delta _1} \\bigg) ^{0.5} $$\nor in more familiar notation\n$$ h_{new} = h_{current} \\bigg(\\frac{tol}{error} \\bigg) ^{0.5} $$\nIn theory, using this formula should mean that we get the correct step size in one iteration instead of two or three. However, in practice, our error is only an approximation and so we should put in a safety factor to make the new step size slightly smaller that the theoretical value:\n$$ h_{new} = 0.9 h_{current} \\bigg(\\frac{tol}{error} \\bigg) ^{0.5} $$\nLet’s use this instead of our doubling and halving approach and see how many calculations we use. Note that formula has the correct behaviour for errors that are both larger and smaller than the tolerance. We can see the result in Figure 10.\nFigure 10: Euler method solution and error with a better adaptive step size, tol = 0.01.\nFigure 10 code\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 ''' Implementing an adaptive step size with better step sizing. Created by: simmeon Last Modified: 19/05/24 License: MIT ''' import matplotlib.pyplot as plt import numpy as np plt.style.use('https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle') # Define function and its derivative def dydt(t, y): return 5*t**4 * np.cos(t**5) def analytical_solution(t): return np.sin(t**5) def euler_step(dydt, t0, y0, h): \"\"\" Takes a single 1st order integration step and returns the y value. Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y h: Step size Returns: The y value after the step. \"\"\" y = y0 + h * dydt(t0, y0) return y def rk2_step(dydt, t0, y0, h): \"\"\" Takes a single 2nd order integration step and returns the y value. Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y h: Step size Returns: The y value after the step. \"\"\" k1 = h * dydt(t0, y0) k2 = h * dydt(t0 + h, y0 + k1) y = y0 + (k1 + k2) / 2 return y # Our adaptive Euler numerical solver def euler_solver(dydt, t0, y0, t_end, tol): \"\"\" Solves a first-order ODE using the Euler method with adaptive step sizing. Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y t_end: Final time for integration tol: Error tolerance Returns: Arrays of y, t and local error values for each time step \"\"\" h = 0.1 # set some initial step size t = [t0] y_euler = [y0] y_rk2 = [y0] error = [0] i = 1 count = 0 while t[-1] \u003c t_end: count += 1 # Take a Euler step y_euler.append(euler_step(dydt, t[i-1], y_euler[i-1], h)) t.append(t[i-1] + h) # Take a RK2 step, starting from the previous Euler step value y_rk2.append(rk2_step(dydt, t[i-1], y_euler[i-1], h)) isStepGood = False error.append(np.abs(y_rk2[i] - y_euler[i])) if error[i] \u003c tol: # accept step, make step size bigger for next step isStepGood = True h = 0.9 * h * (tol / error[i]) ** 0.5 while not isStepGood: count += 1 # Take a step with both methods y_euler[i] = euler_step(dydt, t[i-1], y_euler[i-1], h) t[i] = t[i-1] + h y_rk2[i] = rk2_step(dydt, t[i-1], y_euler[i-1], h) # Calculate the error between the methods error[i] = np.abs(y_rk2[i] - y_euler[i]) # Check error to accept or reject the step if error[i] \u003e tol: # reject step, halve step size h = 0.9 * h * (tol / error[i]) ** 0.5 else: # accept step, make step size bigger for next step isStepGood = True h = 0.9 * h * (tol / error[i]) ** 0.5 i += 1 print(\"Count: \", count) return t, y_euler, error # Define simulation parameters t0 = 0 y0 = 0 t_end = 2 tol = 1e-2 # Numerically integrate t_euler, y_euler, local_error = euler_solver(dydt, t0, y0, t_end, tol) t_euler = np.array(t_euler) y_euler = np.array(y_euler) # Get analytical solution t_analytical = np.arange(t0, t_end, 0.001) y_analytical = analytical_solution(t_analytical) # Get error y_analytical_compare = analytical_solution(t_euler) error = np.abs(y_euler - y_analytical_compare) # Plotting plt.subplot(3,1,1) plt.plot(t_analytical, y_analytical, label='Analytical', linestyle='-') plt.plot(t_euler, y_euler, label='Euler method') plt.scatter(t_euler, y_euler, s=30, marker='o', facecolors='none', color='C1') plt.title(\"Integrating with a adaptive step size, tol = 0.01\", fontsize=20) plt.ylabel('y', fontsize=20) plt.legend(fontsize=15) plt.text(0, -0.75, f\"Number of steps: {len(t_euler)}\", fontsize=15) plt.subplot(3,1,2) plt.plot(t_euler, error) plt.ylabel(\"absolute error\", fontsize=20) plt.subplot(3,1,3) plt.plot(t_euler, local_error) plt.ylabel(\"local step error\", fontsize=20) plt.xlabel('t', fontsize=20) plt.show() This change used 216 steps with a total of 323 step calulations, meaning we changed the step size 1.5 times per step. This is much closer to the minimum of 1 change per step. It also ended up requiring less steps than previously, being even more efficient.\nThis step change formula we created can be applied to higher order methods, for example if we were using a 4th order method with 5th order errors we would use:\n$$ h_{new} = 0.9 h_{current} \\bigg(\\frac{tol}{error} \\bigg) ^{\\frac{1}{5}} $$\nA Full RK45 Method Finally, we have all the parts to create a working 4th order Runge-Kutta numerical solver with adaptive step sizing based on 5th order errors.\nWe will start by writing a function that takes a single 5th order step. We are going to use the 5th order step to approximate our “true solution” and compare it to the 4th order step to find our error. The function will then return the 4th order step and the error. One reason this method is so good is because calculating the 5th step reuses a lot of the RK4 step calculations, making it very efficient.\nTo do this we will be using the Dormand-Prince coefficients. These are much messier than the standard coefficients we used before. However, they are very good at minimising the error in the 5th order approximation, which is exactly what we want – we want that 5th order approximation to be as close to the real solution as possible.\nThe intermediate approximations are calculated as follows:\n$$ \\begin{aligned} \u0026k_1 = hf(t_n, y_n) \\\\ {} \\\\ \u0026k_2 = hf \\Big(t_n + \\frac{1}{5}h, y_n + \\frac{1}{5} k_1 \\Big) \\\\ {} \\\\ \u0026k_3 = hf \\Big(t_n + \\frac{3}{10}h, y_n + \\frac{3}{40} k_1 + \\frac{9}{40} k_2 \\Big) \\\\ {} \\\\ \u0026k_4 = hf \\Big(t_n + \\frac{4}{5}h, y_n + \\frac{44}{45} k_1 - \\frac{56}{15} k_2 + \\frac{32}{9} k_3 \\Big) \\\\ {} \\\\ \u0026k_5 = hf \\Big(t_n + \\frac{8}{9}h, y_n + \\frac{19372}{6561} k_1 - \\frac{25360}{2187} k_2 + \\frac{64448}{6561} k_3 - \\frac{212}{729} k_4 \\Big) \\\\ {} \\\\ \u0026k_6 = hf \\Big(t_n + h, y_n + \\frac{9017}{3168} k_1 - \\frac{355}{33} k_2 - \\frac{46732}{5247} k_3 + \\frac{49}{176} k_4 - \\frac{5103}{18656} k_5 \\Big) \\\\ {} \\\\ \u0026k_7 = hf \\Big(t_n + h, y_n + \\frac{35}{848} k_1 + \\frac{500}{1113} k_3 + \\frac{125}{192} k_4 - \\frac{2187}{6784} k_5 + \\frac{11}{84} k_6 \\Big) \\end{aligned} $$\nThen, the next 4th order step is calculated as\n$$ y_{n+1} = y_n + \\frac{35}{384} k_1 + \\frac{500}{1113} k_3 + \\frac{125}{192} k_4 - \\frac{2187}{6784} k_5 + \\frac{11}{84} k_6 $$\nNote that these are the same coefficients that we use for \\( k_7 \\), which is useful. We can rewrite \\( k_7 \\) as\n$$ k_7 = hf \\Big( t_n + h, y_{n+1} \\Big) $$\nThis value is then the same as \\( k_1 \\) will be in the next step (except for \\( h \\) changing). This means that, except for the first step, we only have to calculate 6 derivatives per step.\nThen, the 5th order step, \\( z_{n+1} \\), is calculated as\n$$ z_{n+1} = y_n + \\frac{5179}{57600} k_1 + \\frac{7571}{16695} k_3 + \\frac{393}{640} k_4 - \\frac{92097}{339200} k_5 + \\frac{187}{2100} k_6 + \\frac{1}{40} k_7 $$\nThis gives the error\n$$ error = \\Big| z_{n+1} - y_{n+1} \\Big| = \\Big| -\\frac{71}{57600} k_1 + \\frac{71}{16695} k_3 - \\frac{71}{1920} k_4 + \\frac{17253}{339200} k_5 - \\frac{22}{525} k_6 + \\frac{1}{40} k_7 \\Big| $$\nand from earlier we know that our step size change will be\n$$ h_{new} = 0.9 h_{current} \\bigg(\\frac{tol}{error} \\bigg) ^{0.2} $$\nLet’s write this step function now, along with the function that adaptively steps to return the solution.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 # ----- Dormand-Prince coefficients ----- # # Alpha in notation, coefficients describe what percentage of the full # step we evaluate each derivative at A = np.array([0, 1/5, 3/10, 4/5, 8/9, 1, 1]) # Beta in notation, coefficients describe how much of each previous change in y # we add to the current estimate B = np.array([ [0, 0, 0, 0, 0, 0], [1/5, 0, 0, 0, 0, 0], [3/40, 9/40, 0, 0, 0, 0], [44/45, -56/15, 32/9, 0, 0, 0], [19372/6561, -25360/2187, 64448/6561, -212/729, 0, 0], [9017/3168, -355/33, 46732/5247, 49/176, -5103/18656, 0], [35/384, 0, 500/1113, 125/192, -2187/6784, 11/84] ]) # Weighting for each derivative in the approximation, w in notation W = np.array([35/384, 0, 500/1113, 125/192, -2187/6784, 11/84, 0]) #W = np.array([5179/57600, 0, 7571/16695, 393/640, -92097/339200, 187/2100, 1/40]) # Coefficients for error calculation E = np.array([-71/57600, 0, 71/16695, -71/1920, 17253/339200, -22/525, 1/40]) # ------------------------------------------------------------------ # # Define a function to take a single RK45 step def rk45_step(dydt, t0, y0, h): \"\"\" Takes a single 5th order integration step and returns the 4th order step along with the 5th order error. Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y h: Step size Returns: The the 4th order y value along with the 5th order error. \"\"\" k1 = h * dydt(t0, y0) k2 = h * dydt(t0 + A[1] * h, y0 + B[1][0]*k1) k3 = h * dydt(t0 + A[2] * h, y0 + B[2][0]*k1 + B[2][1]*k2) k4 = h * dydt(t0 + A[3] * h, y0 + B[3][0]*k1 + B[3][1]*k2 + B[3][2]*k3) k5 = h * dydt(t0 + A[4] * h, y0 + B[4][0]*k1 + B[4][1]*k2 + B[4][2]*k3 + B[4][3]*k4) k6 = h * dydt(t0 + A[5] * h, y0 + B[5][0]*k1 + B[5][1]*k2 + B[5][2]*k3 + B[5][3]*k4 + B[5][4]*k5) y = y0 + W[0]*k1 + W[1]*k2 + W[2]*k3 + W[3]*k4 + W[4]*k5 + W[5]*k6 k7 = h * dydt(t0 + A[6] * h, y) error = np.abs( E[0]*k1 + E[1]*k2 + E[2]*k3 + E[3]*k4 + E[4]*k5 + E[5]*k6 + E[6]*k7 ) return y, error # Define the full RK45 solver function def rk45_solver(dydt, t0, y0, t_end, tol): \"\"\" Solves a first-order ODE using the RK45 method. Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y t_end: Final time for integration tol: Error tolerance Returns: Arrays of y, t and local error values for each time step \"\"\" h = 1e-3 # set some initial step size t = [t0] y = [y0] error = [0] i = 1 while t[-1] \u003c t_end: # Take a step t.append(t[i-1] + h) y_step, error_step = rk45_step(dydt, t[i-1], y[i-1], h) y.append(y_step) error.append(error_step) # Update step size after step h = 0.9 * h * (tol / error[i]) ** 0.2 isStepGood = False if error[i] \u003c tol: # accept step isStepGood = True while not isStepGood: # If there was too much error... # Take a step t[i] = t[i-1] + h # update our time value with the new step size y_step, error_step = rk45_step(dydt, t[i-1], y[i-1], h) y[i] = y_step error[i] = error_step # Update step size after step h = 0.9 * h * (tol / error[i]) ** 0.2 # Check error to accept or reject the step if error[i] \u003c tol: isStepGood = True i += 1 return t, y, error Using this step function along with updating the step size gives the result in Figure 11.\nFigure 11: RK45 Solver with error.\nFigure 11 code (full solver code + graphing)\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 ''' Implementing a complete RK45 algorithm. Created by: simmeon Last Modified: 19/05/24 License: MIT ''' import matplotlib.pyplot as plt import numpy as np plt.style.use('https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle') # Define function (for analytical solution) and its derivative def dydt(t, y): return 5*t**4 * np.cos(t**5) def analytical_solution(t): return np.sin(t**5) # ----- Dormand-Prince coefficients ----- # # Alpha in notation, coefficients describe what percentage of the full # step we evaluate each derivative at A = np.array([0, 1/5, 3/10, 4/5, 8/9, 1, 1]) # Beta in notation, coefficients describe how much of each previous change in y # we add to the current estimate B = np.array([ [0, 0, 0, 0, 0, 0], [1/5, 0, 0, 0, 0, 0], [3/40, 9/40, 0, 0, 0, 0], [44/45, -56/15, 32/9, 0, 0, 0], [19372/6561, -25360/2187, 64448/6561, -212/729, 0, 0], [9017/3168, -355/33, 46732/5247, 49/176, -5103/18656, 0], [35/384, 0, 500/1113, 125/192, -2187/6784, 11/84] ]) # Weighting for each derivative in the approximation, w in notation W = np.array([35/384, 0, 500/1113, 125/192, -2187/6784, 11/84, 0]) #W = np.array([5179/57600, 0, 7571/16695, 393/640, -92097/339200, 187/2100, 1/40]) # Coefficients for error calculation E = np.array([-71/57600, 0, 71/16695, -71/1920, 17253/339200, -22/525, 1/40]) # ------------------------------------------------------------------ # # Define a function to take a single RK45 step # To improve efficiency, k7 could be reused as k1 in the following step def rk45_step(dydt, t0, y0, h): \"\"\" Takes a single 5th order integration step and returns the 4th order step along with the 5th order error. Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y h: Step size Returns: The the 4th order y value along with the 5th order error. \"\"\" k1 = h * dydt(t0, y0) k2 = h * dydt(t0 + A[1] * h, y0 + B[1][0]*k1) k3 = h * dydt(t0 + A[2] * h, y0 + B[2][0]*k1 + B[2][1]*k2) k4 = h * dydt(t0 + A[3] * h, y0 + B[3][0]*k1 + B[3][1]*k2 + B[3][2]*k3) k5 = h * dydt(t0 + A[4] * h, y0 + B[4][0]*k1 + B[4][1]*k2 + B[4][2]*k3 + B[4][3]*k4) k6 = h * dydt(t0 + A[5] * h, y0 + B[5][0]*k1 + B[5][1]*k2 + B[5][2]*k3 + B[5][3]*k4 + B[5][4]*k5) y = y0 + W[0]*k1 + W[1]*k2 + W[2]*k3 + W[3]*k4 + W[4]*k5 + W[5]*k6 k7 = h * dydt(t0 + A[6] * h, y) error = np.abs( E[0]*k1 + E[1]*k2 + E[2]*k3 + E[3]*k4 + E[4]*k5 + E[5]*k6 + E[6]*k7 ) return y, error # Define the full RK45 solver function def rk45_solver(dydt, t0, y0, t_end, tol): \"\"\" Solves a first-order ODE using the RK45 method. Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y t_end: Final time for integration tol: Error tolerance Returns: Arrays of y, t and local error values for each time step \"\"\" h = 1e-3 # set some initial step size t = [t0] y = [y0] error = [0] i = 1 while t[-1] \u003c t_end: # Take a step t.append(t[i-1] + h) y_step, error_step = rk45_step(dydt, t[i-1], y[i-1], h) y.append(y_step) error.append(error_step) # Update step size after step h = 0.9 * h * (tol / error[i]) ** 0.2 isStepGood = False if error[i] \u003c tol: # accept step isStepGood = True while not isStepGood: # If there was too much error... # Take a step t[i] = t[i-1] + h # update our time value with the new step size y_step, error_step = rk45_step(dydt, t[i-1], y[i-1], h) y[i] = y_step error[i] = error_step # Update step size after step h = 0.9 * h * (tol / error[i]) ** 0.2 # Check error to accept or reject the step if error[i] \u003c tol: isStepGood = True i += 1 return t, y, error # Define simulation parameters t0 = 0 y0 = 0 t_end = 2 tol = 1e-6 # Numerically integrate t_rk45, y_rk45, local_error = rk45_solver(dydt, t0, y0, t_end, tol) t_rk45 = np.array(t_rk45) y_rk45 = np.array(y_rk45) # Get analytical solution t_analytical = np.arange(t0, t_end, 0.001) y_analytical = analytical_solution(t_analytical) # Get error y_analytical_compare = analytical_solution(t_rk45) error = np.abs(y_rk45 - y_analytical_compare) # Plotting plt.subplot(3,1,1) plt.plot(t_analytical, y_analytical, label='Analytical', linestyle='-') plt.plot(t_rk45, y_rk45, label='RK45 method') #plt.scatter(t_rk45, y_rk45, s=30, marker='o', facecolors='none', color='C1') plt.title(f\"RK45 Solver, tol = {tol}\", fontsize=20) plt.ylabel('y', fontsize=20) plt.legend(fontsize=15) plt.text(0, -0.75, f\"Number of steps: {len(t_rk45)}\", fontsize=15) plt.subplot(3,1,2) plt.plot(t_rk45, error) plt.ylabel(\"absolute error\", fontsize=20) plt.subplot(3,1,3) plt.plot(t_rk45, local_error) plt.ylabel(\"local step error\", fontsize=20) plt.xlabel('t', fontsize=20) plt.show() As we can see, the method is incredibly efficient and accurate. In comparison, our 1st order adaptive method used over 200 steps for a tolerance of only 1e-03. This combination of efficiency and accuracy makes the RK45 method an incredibly good general solver.\nA Final Application So far we have used mostly trivial or contrived examples to demonstrate why the RK45 solver is good. To finish off, we will use a real-world example where the adaptability, efficiency, and accuracy of the RK45 solver is very useful.\nWe will be using the solver to propagate a satellite orbit around the earth. We will skip some details of deriving the relevant physics, but the important equation is:\n$$ F = \\frac{G m_{earth} m_{sat}}{r^2} $$\nLet’s define the gravitational parameter, \\( \\mu \\)\n$$ \\mu = G(m_{earth} + m_{sat}) $$\nBy assuming an inertial reference frame centred on the Earth, we get\n$$ \\ddot{\\vec{r}} = - \\frac{G(m_{earth} + m_{sat})}{r^3}\\vec{r} \\\\ {} \\\\ \\ddot{\\vec{r}} = - \\frac{\\mu}{r^3}\\vec{r} $$\nwhere \\( \\vec{r} \\) is the position vector of the satellite we want to solve for.\nThis is currently a second order ODE. We can use a state space to transform it into being first order:\n$$ \\bold{x} = \\begin{bmatrix} r_x \\\\ r_y \\\\ \\dot{r}_x \\\\ \\dot{r}_y \\end{bmatrix} \\\\ {} \\\\ {} \\\\ \\bold{\\dot{x}} = \\begin{bmatrix} \\dot{r}_x \\\\ {} \\\\ \\dot{r}_y \\\\ {} \\\\ \\ddot{r}_x \\\\ {} \\\\ \\ddot{r}_y \\\\ \\end{bmatrix} = \\begin{bmatrix} \\dot{r}_x \\\\ {} \\\\ \\dot{r}_y \\\\ {} \\\\ -\\Large \\frac{\\mu r_x}{|r|^3} \\\\ {} \\\\ -\\Large \\frac{\\mu r_y}{|r|^3} \\\\ \\end{bmatrix} \\\\ {} \\\\ {} \\\\ \\bold{\\dot{x}} = \\begin{bmatrix} 0 \u0026 0 \u0026 1 \u0026 0 \\\\ 0 \u0026 0 \u0026 0 \u0026 1 \\\\ -\\Large \\frac{\\mu}{|r|^3} \u0026 0 \u0026 0 \u0026 0 \\\\ 0 \u0026 -\\Large \\frac{\\mu}{|r|^3} \u0026 0 \u0026 0 \\end{bmatrix} \\bold{x} $$\nThis is now a system of first order ODEs where we are solving for \\( \\bold{x} \\). With some small code changes to allow for vector inputs, Figure 12 shows the resulting satellite position and velocity for some initial state. To deal with multiple ODE systems with arrays of solutions instead of just a single value, we use the maximum error as our test for whether the step was good or not.\nFigure 12: Propagating an orbit with RK45.\nFigure 12 code\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 ''' An application of the RK45 ODE solver. We will solve for the position of a satellite around Earth given an initial position and velocity. Created by: simmeon Last Modified: 19/05/24 License: MIT ''' import matplotlib.pyplot as plt import numpy as np plt.style.use('https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle') # Define derivative def dxdt(t, x): r_mag = np.sqrt(x[0]**2 + x[1]**2) mu = 398600.4415; # [km^3 / (kg*s^2)] return np.array([x[2], x[3], -mu * x[0] / (r_mag**3), -mu * x[1] / (r_mag**3)]) # ----- Dormand-Prince coefficients ----- # # Alpha in notation, coefficients describe what percentage of the full # step we evaluate each derivative at A = np.array([0, 1/5, 3/10, 4/5, 8/9, 1, 1]) # Beta in notation, coefficients describe how much of each previous change in y # we add to the current estimate B = np.array([ [0, 0, 0, 0, 0, 0], [1/5, 0, 0, 0, 0, 0], [3/40, 9/40, 0, 0, 0, 0], [44/45, -56/15, 32/9, 0, 0, 0], [19372/6561, -25360/2187, 64448/6561, -212/729, 0, 0], [9017/3168, -355/33, 46732/5247, 49/176, -5103/18656, 0], [35/384, 0, 500/1113, 125/192, -2187/6784, 11/84] ]) # Weighting for each derivative in the approximation, w in notation W = np.array([35/384, 0, 500/1113, 125/192, -2187/6784, 11/84, 0]) #W = np.array([5179/57600, 0, 7571/16695, 393/640, -92097/339200, 187/2100, 1/40]) # Coefficients for error calculation E = np.array([-71/57600, 0, 71/16695, -71/1920, 17253/339200, -22/525, 1/40]) # ------------------------------------------------------------------ # # Define a function to take a single RK45 step # To improve efficiency, k7 can be reused as k1 in the following step def rk45_step(dydt, t0, y0, h): \"\"\" Takes a single 5th order integration step and returns the 4th order step along with the 5th order error. Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y h: Step size Returns: The the 4th order y value along with the 5th order error. \"\"\" k1 = h * dydt(t0, y0) k2 = h * dydt(t0 + A[1] * h, y0 + B[1][0]*k1) k3 = h * dydt(t0 + A[2] * h, y0 + B[2][0]*k1 + B[2][1]*k2) k4 = h * dydt(t0 + A[3] * h, y0 + B[3][0]*k1 + B[3][1]*k2 + B[3][2]*k3) k5 = h * dydt(t0 + A[4] * h, y0 + B[4][0]*k1 + B[4][1]*k2 + B[4][2]*k3 + B[4][3]*k4) k6 = h * dydt(t0 + A[5] * h, y0 + B[5][0]*k1 + B[5][1]*k2 + B[5][2]*k3 + B[5][3]*k4 + B[5][4]*k5) y = y0 + W[0]*k1 + W[1]*k2 + W[2]*k3 + W[3]*k4 + W[4]*k5 + W[5]*k6 k7 = h * dydt(t0 + A[6] * h, y) error = np.abs( E[0]*k1 + E[1]*k2 + E[2]*k3 + E[3]*k4 + E[4]*k5 + E[5]*k6 + E[6]*k7 ) return y, error # Define the full RK45 solver function def rk45_solver(dydt, t0, y0, t_end, tol): \"\"\" Solves a first-order ODE using the RK45 method. Args: dydt: The differential equation (dy/dt) as a Python function t0: Initial value of time y0: Initial value of y t_end: Final time for integration tol: Error tolerance Returns: Arrays of y, t and local error values for each time step \"\"\" h = 1e-3 # set some initial step size t = [t0] y = np.array([y0]) error = [0] i = 1 while t[-1] \u003c t_end: # Take a step t.append(t[i-1] + h) y_step, error_step = rk45_step(dydt, t[i-1], y[i-1], h) y = np.append(y, np.array([y_step]), axis=0) error.append(error_step) # Update step size after step h = 0.9 * h * (tol / max(error[i])) ** 0.2 isStepGood = False if max(error[i]) \u003c tol: # accept step isStepGood = True while not isStepGood: # If there was too much error... # Take a step t[i] = t[i-1] + h # update our time value with the new step size y_step, error_step = rk45_step(dydt, t[i-1], y[i-1], h) y[i] = y_step error[i] = error_step # Update step size after step h = 0.9 * h * (tol / max(error[i])) ** 0.2 # Check error to accept or reject the step if max(error[i]) \u003c tol: isStepGood = True i += 1 return t, y, error # Define orbit parameters mu = 398600.4415 rp = 6678 e = 0.9 a = rp/(1-e) T = 2*np.pi*np.sqrt(a**3/mu) # Define simulation parameters t0 = 0 x0 = np.array([rp, 0, 0, np.sqrt(2*mu/rp - mu/a)]) t_end = T tol = 1e-12 # Numerically integrate t_rk45, y_rk45, local_error = rk45_solver(dxdt, t0, x0, t_end, tol) y_rk45 = np.array(y_rk45) # Plotting plt.subplot(2,1,1) plt.plot(y_rk45[:, 0], y_rk45[:, 1]) plt.axis('equal') plt.scatter(0, 0, s=50) # dot for Earth plt.title(\"Satellite Orbit Around Earth\", fontsize=20) plt.ylabel('y [km]', fontsize=20) plt.xlabel('x [km]', fontsize=20) plt.subplot(2,1,2) plt.plot(t_rk45, np.sqrt(y_rk45[:, 2]**2 + y_rk45[:, 3]**2), color='C1') plt.title(\"Satellite Velocity\", fontsize=20) plt.ylabel('velocity [km/s]', fontsize=20) plt.xlabel('t [s]', fontsize=20) plt.show() The adaptive step size is able to deal with velocity changing by orders of magnitude. With a constant step size, we would be wasting a huge amount of computation on the far side of the orbit. The accuracy of the RK45 method also allows us to use very small tolerances (1e-12) and still have the computation time be relatively quick.\nConclusion This guide should serve as a single comprehensive reference for what the RK45 method is, how it is derived, and how and why we use it to solve engineering problems. There is still room to improve on the ideas and code that have been shown here (the code lacks a lot of polish and dealing with edge cases for example).\nHowever, for those like me who wanted to understand where this method comes from and why it is so good, I hope this has been a useful reference. The goal was to make these quite dense mathematical concepts as clear as possible for other engineers like me.\nReferences [1] Roson J. S., “The Runge-Kutta Equations by Quadrature Methods”, 1967, NASA.\n[2] “Runge-Kutta Methods”, 10.001: Numerical Solution of Ordinary Differential Equations\n[3] Explanation and proof of the 4th order Runge-Kutta method\n[4] Numerical Recipes in C: The Art of Scientific Computing\n[5] S. Brorson, “Numerically Solving Ordinary Differential Equations”\n[6] Adaptive Runge-Kutta Methods | Lecture 54 | Numerical Methods for Engineers\n[7] Dormand, J. R. and P. J. Prince, “A family of embedded Runge-Kutta formulae,” J. Comp. Appl. Math., Vol. 6, 1980, pp. 19–26.\n[8] Dormand-Prince Method\n",
  "wordCount" : "12504",
  "inLanguage": "en",
  "image": "http://localhost:1313/blog/images/papermod-cover.png","datePublished": "2024-05-18T00:00:00Z",
  "dateModified": "2024-05-18T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "simmeon"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/blog/posts/rk45/rk45/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "simmeon's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/blog/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/blog/" accesskey="h" title="simmeon&#39;s blog (Alt + H)">simmeon&#39;s blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/blog/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/blog/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/blog/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/blog/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/blog/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      An Engineer&#39;s Guide to the Runge-Kutta (RK45) Method
    </h1>
    <div class="post-description">
      Understanding what the RK45 method is, a complete derivation, and applying it to engineering problems.
    </div>
    <div class="post-meta"><span title='2024-05-18 00:00:00 +0000 UTC'>May 18, 2024</span>&nbsp;·&nbsp;59 min&nbsp;·&nbsp;12504 words&nbsp;·&nbsp;simmeon&nbsp;|&nbsp;<a href="https://github.com/simmeon/blog/blob/main/content/posts/rk45/rk45.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#the-initial-value-problem" aria-label="The Initial Value Problem">The Initial Value Problem</a></li>
                <li>
                    <a href="#numerical-methods" aria-label="Numerical Methods">Numerical Methods</a><ul>
                        
                <li>
                    <a href="#the-euler-method" aria-label="The Euler Method">The Euler Method</a></li>
                <li>
                    <a href="#runge-kutta-methods" aria-label="Runge-Kutta Methods">Runge-Kutta Methods</a><ul>
                        
                <li>
                    <a href="#derivation-of-runge-kutta-methods" aria-label="Derivation of Runge-Kutta Methods">Derivation of Runge-Kutta Methods</a><ul>
                        
                <li>
                    <a href="#weighted-sum-approximations" aria-label="Weighted Sum Approximations">Weighted Sum Approximations</a></li>
                <li>
                    <a href="#the-runge-kutta-family" aria-label="The Runge-Kutta Family">The Runge-Kutta Family</a></li>
                <li>
                    <a href="#defining-coefficients" aria-label="Defining Coefficients">Defining Coefficients</a></li></ul>
                </li>
                <li>
                    <a href="#implementing-runge-kutta" aria-label="Implementing Runge-Kutta">Implementing Runge-Kutta</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#step-sizing" aria-label="Step Sizing">Step Sizing</a><ul>
                        
                <li>
                    <a href="#constant-step-size-issues" aria-label="Constant Step Size Issues">Constant Step Size Issues</a></li>
                <li>
                    <a href="#using-multiple-step-sizes" aria-label="Using Multiple Step Sizes">Using Multiple Step Sizes</a></li>
                <li>
                    <a href="#adaptive-step-sizing" aria-label="Adaptive Step Sizing">Adaptive Step Sizing</a></li>
                <li>
                    <a href="#choosing-better-step-size-changes" aria-label="Choosing Better Step Size Changes">Choosing Better Step Size Changes</a></li></ul>
                </li>
                <li>
                    <a href="#a-full-rk45-method" aria-label="A Full RK45 Method">A Full RK45 Method</a></li>
                <li>
                    <a href="#a-final-application" aria-label="A Final Application">A Final Application</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a></li>
                <li>
                    <a href="#references" aria-label="References">References</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content">


<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>


<h2 id="the-initial-value-problem">The Initial Value Problem<a hidden class="anchor" aria-hidden="true" href="#the-initial-value-problem">#</a></h2>
<p>In engineering, we often encounter systems that evolve over time, such as circuits, mechanical systems, or chemical reactions. These systems are best described using differential equations.
For example, Newton&rsquo;s law of cooling states:</p>
<p>$$
\dfrac{dT}{dt} = -k(T - T_{surr})
$$</p>
<p>where <strong>T</strong> is the temperature of some point, <strong>k</strong> is a proportionality constant, and <strong>T<sub>surr<sub></strong> is the temperature surrounding the point of interest.</p>
<p>To solve this equation is to find a solution for the temperature, <strong>T</strong>, over time. In this case, this is fairly straightforward and we can come up with an analytical solution of the form:</p>
<p>$$
T(t) = T_{surr} + (T(0) - T_{surr})e^{-kt}
$$</p>
<p>Notice that the solution <em><strong>depends on the initial temperature</strong></em>, as <strong>Figure 1</strong> shows. We need a point of reference to define the solution that is relevant to our system.</p>
<figure class="align-center ">
    <img loading="lazy" src="../img/heat-transfer.png#center"
         alt="Figure 1: Temperature of a point over time with different initial temperatures. Tsurr = 20 C, k = 1."/> <figcaption>
            <p><strong>Figure 1</strong>: Temperature of a point over time with different initial temperatures. T<sub>surr</sub> = 20 C, k = 1.</p>
        </figcaption>
</figure>



<p><details >
  <summary markdown="span">Figure 1 code</summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Plotting the temperature of a point with different starting temperatures.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Created by: simmeon
</span></span></span><span class="line"><span class="cl"><span class="s1">Last Modified: 28/04/24
</span></span></span><span class="line"><span class="cl"><span class="s1">License: MIT
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define system parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">T_surr</span> <span class="o">=</span> <span class="mi">20</span>     <span class="c1"># surrounding temperature of 20 C</span>
</span></span><span class="line"><span class="cl"><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>           <span class="c1"># proportionality constant of 1 for simplicity</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define our cooling function</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">solve_T</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">T0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">T_surr</span> <span class="o">+</span> <span class="p">(</span><span class="n">T0</span> <span class="o">-</span> <span class="n">T_surr</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create an array of times from 0-5 seconds</span>
</span></span><span class="line"><span class="cl"><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Solve and plot the solutions for different initial values of T</span>
</span></span><span class="line"><span class="cl"><span class="n">T0_choices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">T0</span> <span class="ow">in</span> <span class="n">T0_choices</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">T</span> <span class="o">=</span> <span class="n">solve_T</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">T0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;T0 = </span><span class="si">{}</span><span class="s1"> C&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Temperature over time&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Temperature [C]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</details></p>

<p>The initial value problem deals with solving these ordinary differential equations where we have an initial state of the system, eg. the initial temperature is 25 C. However, often these systems are hard or impossible to solve analytically. To solve them, we use numerical methods to approximate the solution. Let&rsquo;s look at how we might be able to do that&hellip;</p>
<h2 id="numerical-methods">Numerical Methods<a hidden class="anchor" aria-hidden="true" href="#numerical-methods">#</a></h2>
<p>Let&rsquo;s take the previous cooling equation,</p>
<p>$$
\dfrac{dT}{dt} = -k(T - T_{surr})
$$</p>
<p>and assume we can&rsquo;t find an analytical solution. Let&rsquo;s consider the information we <em>do</em> have that could help us approximate the solution. We have an expression for the derivative that we can calculate at any time, <em><strong>t</strong></em>, assuming we know the current temperature at that time. We know the temperature at some initial time (<em><strong>t</strong></em> = 0 in this case), so we can calculate the derivative at that time. But how does this help us find the temperature at other times?</p>
<h3 id="the-euler-method">The Euler Method<a hidden class="anchor" aria-hidden="true" href="#the-euler-method">#</a></h3>
<p>From calculus we know that we get the derivative of a function by taking two points on the function and approximating the derivative as if it were a striaght line. As the distance, <em><strong>h</strong></em>, between the two points gets closer to 0, the approximation gets better. Formally,</p>
<p>$$
f^{\prime}(x) = \lim_{h \rightarrow 0} \frac{f(x+h) - f(x)}{h}
$$</p>
<p>We can rearrange this and assume a finite step size, <em><strong>h</strong></em>, to get</p>
<p>$$
f(x+h) \approx f(x) + h f^{\prime}(x)
$$</p>
<p>which gives us an expression to approximate the next step of a function using only the current known function value and the function derivative. We can see what this looks like with different step sizes in <strong>Figure 2</strong>.</p>
<figure class="align-center ">
     <img loading="lazy" src="../img/the_derivative.png#center"
          alt="Figure 2: Estimating the value of y = x2 with different step sizes."/> <figcaption>
             <p><strong>Figure 2</strong>: Estimating the value of y = x<sup>2</sup> with different step sizes.</p>
         </figcaption>
 </figure>



<p><details >
  <summary markdown="span">Figure 2 code</summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Visualising how the derivative can be used to estimate the value of a function.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Created by: simmeon
</span></span></span><span class="line"><span class="cl"><span class="s1">Last Modified: 28/04/24
</span></span></span><span class="line"><span class="cl"><span class="s1">License: MIT
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define some function we want to find the value of</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="o">**</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define the derivative line of the function</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">t0</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span> <span class="o">+</span> <span class="n">y0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create an array of time values to plot the function</span>
</span></span><span class="line"><span class="cl"><span class="n">t_func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Estimation parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">t0</span> <span class="o">=</span> <span class="mf">1.0</span>                    <span class="c1"># known initial value</span>
</span></span><span class="line"><span class="cl"><span class="n">y0</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>               <span class="c1"># known initial value</span>
</span></span><span class="line"><span class="cl"><span class="n">h</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>           <span class="c1"># step size options</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plotting</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Find and plot function values</span>
</span></span><span class="line"><span class="cl"><span class="n">y_func</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">t_func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_func</span><span class="p">,</span> <span class="n">y_func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plot the derivative line for each step size</span>
</span></span><span class="line"><span class="cl"><span class="n">colours</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;C3&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">t_dydt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y_dydt</span> <span class="o">=</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t_dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_dydt</span><span class="p">,</span> <span class="n">y_dydt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Step = </span><span class="si">{:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_dydt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_dydt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Show plot</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Estimating a function by using the derivative&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</details></p>

<p>This is Euler&rsquo;s method for solving the initial value problem. We might also write it as:</p>
<p>$$
f_{k+1} \approx f_{k} + h f^{\prime}(x_{k})
$$</p>
<p>for some index, <em><strong>k</strong></em>.</p>
<p>We can iterate through time with this method, using the newly found <em>f<sub>k+1</sub></em> as our new <em>f<sub>k</sub></em> and so on. In code, that would look like the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="hl"><span class="lnt">14
</span></span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">euler</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    Takes the derivative function, an initial condition, 
</span></span></span><span class="line"><span class="cl"><span class="s1">    the time we want to integrate until, and a step size.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    Returns arrays of time and y values.
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
</span></span><span class="line hl"><span class="cl">        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The highlighted line shows the Euler method itself where the next value of the function is estimated.</p>
<p>Let&rsquo;s try do that with Newton&rsquo;s cooling law and see how the result compares to the analytical solution. <strong>Figure 3</strong> shows what that would look like.</p>
<figure class="align-center ">
    <img loading="lazy" src="../img/euler_method.png#center"
         alt="Figure 3: Analytical and Euler method solutions to Newton&rsquo;s cooling law. Tsurr = 20 C, k = 1."/> <figcaption>
            <p><strong>Figure 3</strong>: Analytical and Euler method solutions to Newton&rsquo;s cooling law. T<sub>surr</sub> = 20 C, k = 1.</p>
        </figcaption>
</figure>



<p><details >
  <summary markdown="span">Figure 3 code</summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Performing Euler integration to solve the cooling equation. We will compare with the analytical solution.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Created by: simmeon
</span></span></span><span class="line"><span class="cl"><span class="s1">Last Modified: 28/04/24
</span></span></span><span class="line"><span class="cl"><span class="s1">License: MIT
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define system</span>
</span></span><span class="line"><span class="cl"><span class="n">T_surr</span> <span class="o">=</span> <span class="mi">20</span>     <span class="c1"># surrounding temperature of 20 C</span>
</span></span><span class="line"><span class="cl"><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>           <span class="c1"># proportionality constant of 1 for simplicity</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define our cooling function</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">solve_T</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">T0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">T_surr</span> <span class="o">+</span> <span class="p">(</span><span class="n">T0</span> <span class="o">-</span> <span class="n">T_surr</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define the derivative (only depends on the current temp, not time)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dTdt</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span> <span class="o">-</span> <span class="n">T_surr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define our Euler integration function</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">euler</span><span class="p">(</span><span class="n">dTdt</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    Takes the derivative function, an initial condition, the time we want to integrate until,
</span></span></span><span class="line"><span class="cl"><span class="s1">    and a step size.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    Returns arrays of time and temperature values
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">T0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dTdt</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">T</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">T0</span> <span class="o">=</span> <span class="mi">30</span>
</span></span><span class="line"><span class="cl"><span class="n">t_end</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get analytical solution</span>
</span></span><span class="line"><span class="cl"><span class="n">t_analytical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">T_analytical</span> <span class="o">=</span> <span class="n">solve_T</span><span class="p">(</span><span class="n">t_analytical</span><span class="p">,</span> <span class="n">T0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get Euler numerical solution</span>
</span></span><span class="line"><span class="cl"><span class="n">t_euler_05</span><span class="p">,</span> <span class="n">T_euler_05</span> <span class="o">=</span> <span class="n">euler</span><span class="p">(</span><span class="n">dTdt</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">t_euler_01</span><span class="p">,</span> <span class="n">T_euler_01</span> <span class="o">=</span> <span class="n">euler</span><span class="p">(</span><span class="n">dTdt</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plotting</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_analytical</span><span class="p">,</span> <span class="n">T_analytical</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Analytical&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_euler_05</span><span class="p">,</span> <span class="n">T_euler_05</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Euler method, h = 0.5&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_euler_01</span><span class="p">,</span> <span class="n">T_euler_01</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Euler method, h = 0.1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Analytical and Euler method solutions to Newton&#39;s cooling law&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Temperature [C]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</details></p>

<p>It is clear that the step size plays a big role in the accuracy of the solution. We could continue to reduce the step size, but that will quickly increase the time it takes to get a solution beyond a reasonable amount. Maybe we can think of a better way of doing this&hellip;</p>
<h3 id="runge-kutta-methods">Runge-Kutta Methods<a hidden class="anchor" aria-hidden="true" href="#runge-kutta-methods">#</a></h3>
<p>A major problem with Euler&rsquo;s method is that using the derivative of the point we&rsquo;re at is not very good at estimating the next value of the function (for the kind of step sizes we want to use). The derivative is constantly changing and could be vastly different at the new value. We might get a more accurate step if we use a mix of the derivative at our start point and end point.</p>
<p>This is the basis for how Runge-Kutta methods work. We find derivatives between the start and end points of each step and use a weighted average of those as the actual derivative for the step. The simplest version of this would be to just use the derivative at the start of the step &ndash; which is exactly the Euler method! The Euler method is a 1st order Runge-Kutta method.</p>
<p>Let&rsquo;s define the method more concretely.</p>
<h4 id="derivation-of-runge-kutta-methods">Derivation of Runge-Kutta Methods<a hidden class="anchor" aria-hidden="true" href="#derivation-of-runge-kutta-methods">#</a></h4>
<p>We will start by examining the initial problem again, being that we want to solve the following general equation for y:</p>
<p>$$
\dfrac{dy}{dt} = f(y, t)
$$</p>
<p>This could be our cooling equation from before,</p>
<p>$$
\dfrac{dT}{dt} = -k(T - T_{surr})
$$</p>
<p>or something more complex like a state space defining a spring, mass, damper system:</p>
<p>$$
\bold{\dot{x}} =
\begin{bmatrix} 0 &amp; 1 \\ \frac{-k}{m} &amp; \frac{-c}{m} \end{bmatrix} \bold{x} +
\begin{bmatrix} 0  \\ \frac{1}{m} \end{bmatrix} u(t)
$$</p>
<p>In both cases, we are given the derivative of the state we want to solve for (eg. temperature) and the derivative depends on the value of the state and time. In the case of the cooling equation, the derivative only depends on the state, <strong>T</strong>, and not time.</p>
<p>Ideally, we could just integrate the derivative to find the value at \( t + h \):</p>
<p>$$
y(t+h) = y(t) + \int_{\tau=t}^{\tau=t+h}{\dfrac{dy(\tau)}{d\tau}} d\tau
$$</p>
<p>However, as we said earlier, this is often hard or impossible. We can instead approximate the integral with a weighted sum.</p>
<h5 id="weighted-sum-approximations">Weighted Sum Approximations<a hidden class="anchor" aria-hidden="true" href="#weighted-sum-approximations">#</a></h5>
<p>Let&rsquo;s build this up slowly. Take the following function, for example:</p>
<p>$$
f(t) = t^3 - 2t^2 - t + 3
$$</p>
<p>How would we evaluate</p>
<p>$$
\int_0^2{f(t)}dt
$$</p>
<p>We can do this analytically, which is like summing up tiny vertical slices of the function to find the total area underneath it. But we could think about this a different way. We can get that same area by finding the average value of the function over the interval, then multiplying by the length of the interval. You can see this in <strong>Figure 4</strong>.</p>
<figure class="align-center ">
    <img loading="lazy" src="../img/weighted_sum_approx.png#center"
         alt="Figure 4: Comparison of areas found by integration and weighted sum approximation."/> <figcaption>
            <p><strong>Figure 4</strong>: Comparison of areas found by integration and weighted sum approximation.</p>
        </figcaption>
</figure>



<p><details >
  <summary markdown="span">Figure 4 code</summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Making sense of weighted sums as integral approximations.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Created by: simmeon
</span></span></span><span class="line"><span class="cl"><span class="s1">Last Modified: 28/04/24
</span></span></span><span class="line"><span class="cl"><span class="s1">License: MIT
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Perform a weighted sum approximation</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># higher number of samples, N, gives a better approximation</span>
</span></span><span class="line"><span class="cl"><span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">h</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t0</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">sum</span> <span class="o">+=</span> <span class="n">f</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">weighted_sum</span> <span class="o">=</span> <span class="nb">sum</span> <span class="o">/</span> <span class="n">N</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Weighted sum area: &#39;</span><span class="p">,</span> <span class="n">weighted_sum</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plotting</span>
</span></span><span class="line"><span class="cl"><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Integration result</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Area = 2.67&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mf">2.5</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Area from integration&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Weighted sum result</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">weighted_sum</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Area = </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weighted_sum</span> <span class="o">*</span> <span class="n">h</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mf">2.5</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Area from weighted sum&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</details></p>

<p>To put this idea into an equation, we can say:</p>
<p>$$
\int_0^2{f(t)}dt \approx \frac{2}{\sum{w_i}} \sum_{i=1}^N{w_i  f(t_i)}
$$</p>
<p>Where \( N \) is the number of points we sample from the function to find the average, \( w_i \) is the weighting we give to each point, and \( t_i \) is some point inside the integration bounds of \( [0, 2] \). We can simplify this by giving every point a weighting of 1:</p>
<p>$$
\int_0^2{f(t)}dt \approx \frac{2}{N} \sum_{i=1}^N{f(t_i)}
$$</p>
<p>The more points we sample, the closer the average will be to the actual average of the function and therefore the actual integral.</p>
<p>We can extend this concept to our derivative from earlier:</p>
<p>$$
\int_{\tau=t}^{\tau=t+h}{\dfrac{dy(\tau)}{d\tau}} d\tau
\approx
\frac{h}{\sum{w_i}} \sum_{i=1}^N{w_i y^{\prime}(t+v_i h, y(t+v_i h))}
$$</p>
<p><em><strong>What a mess.</strong></em></p>
<p>We&rsquo;re still using the same concept of a weighted sum to find the average value of the derivative function, but since the derivative depends on \( t \) <em>and</em> \( y \) it&rsquo;s a bit more complicated. We introduced \( v_i \) to help define which values of the function we sample, also called <em>nodes</em>. This can range from 0 to 1 to cover the interval from \( t \) to \( t+h \). Of course, whatever time we evaluate our derivative at must be the same time we use to get the \( y \) values for the derivative.</p>
<p>For the sake of simplicity let&rsquo;s say that all our weights will sum up to 1. We are <strong>not</strong>, however, going to assume that all our weights will be the same value as we did previously.</p>
<p>Considering all this, the equation we are trying to solve is now:</p>
<p>$$
y(t+h) = y(t) + h \sum_{i=1}^N{w_i y^{\prime}(t+v_i h, y(t+v_i h))}
$$</p>
<h5 id="the-runge-kutta-family">The Runge-Kutta Family<a hidden class="anchor" aria-hidden="true" href="#the-runge-kutta-family">#</a></h5>
<p>You might have noticed there is a problem with the sum we just defined. In particular, we don&rsquo;t know what \( y(t+v_i h) \) is. In fact, finding this is basically the point of the whole method. So how do we deal with this?</p>
<p>Simply, we are going to make worse approximations of \( y(t+v_i h) \) so that we can make a much better approximation of \( y(t + h) \). Again, these \( y(t+v_i h) \) values are used to find values of the derivative that we will then average. Let&rsquo;s define what we will do to find these approximations.</p>
<p>We will start by saying that \( v_1 = 0 \). This means the first term in the sum will be</p>
<p>$$
w_1 y^{\prime}(t, y(t))
$$</p>
<p>If this was the only term in our sum (so \( w_1 = 1 \) ), then the equation we would be solving would be:</p>
<p>$$
y(t+h) \approx y(t) + h y^{\prime}(t, y(t))
$$</p>
<p>This should look familiar, it&rsquo;s the Euler method! This is what we mean by the Euler method is a 1st order Runge-Kutta method &ndash; because it uses one term in the weighted sum. Or in other words, it is a linear approximation.</p>
<p>For simplicity, we will write this first sum term as:</p>
<p>$$
k_1 = y^{\prime}(t, y(t)) h
$$</p>
<p>\( k_1 \) is a 1st order estimate of the change in \( y \) between \( y(t) \) and \( y(t+h) \).</p>
<p>The second term gets trickier as we have to somehow estimate \( y(t+v_2 h) \). Conveniently, we have just found an estimate for how \( y \) changes: \( k_1 \). So we can utilise some fraction of this change to create our estimate for the second weighted sum term where:</p>
<p>$$
y^{\prime}(t + \alpha_2 h, y(t) + \beta_{2,1} k_1)
$$</p>
<p>We don&rsquo;t know yet how much of \( k_1 \) we should add, we will figure that out later. Same with what time we should sample at.</p>
<p>We have changed notation slightly to help set up higher order Runge-Kutta methods. Instead of \( v_i \) we are now using \( \alpha_i \) to tell us about what time we are sampling at. And since our \( y \) value is no longer defined in simple terms of time, we are going to use \( \beta_{i,j} \) to describe how much of previous estimates we will add to the estimate for the new term.</p>
<p>We define</p>
<p>$$
k_2 = y^{\prime}(t + \alpha_2 h, y(t) + \beta_{2,1} k_1) h
$$</p>
<p>so that the equation we are solving is now:</p>
<p>$$
y(t+h) \approx y(t) + w_1 k_1 + w_2 k_2
$$</p>
<p>With that, we have defined the 2nd order Runge-Kutta Method!</p>
<p>We can continue the weighted sum with a third and fourth term, following similar logic of using the previous estimates to inform the new value of \( y(t + v_i h) \). This will give us:</p>
<p>$$
k_3 = y^{\prime}(t + \alpha_3 h, y(t) + \beta_{3,1} k_1 + \beta_{3,2} k_2) h
\\
k_4 = y^{\prime}(t + \alpha_4 h, y(t) + \beta_{4,1} k_1 + \beta_{4,2} k_2 + \beta_{4,3} k_3) h
$$</p>
<p>This gives the 4th order Runge-Kutta method:</p>
<p>$$
y(t+h) \approx y(t) + w_1 k_1 + w_2 k_2 + w_3 k_3 + w_4 k_4
$$</p>
<p>Now to actually solve these higher order methods, we need to define these coefficients&hellip;</p>
<h5 id="defining-coefficients">Defining Coefficients<a hidden class="anchor" aria-hidden="true" href="#defining-coefficients">#</a></h5>
<p>We need to define all the \( \alpha_i \), \( \beta_{i,j} \), and \( w_i \) coefficients to be able to use these methods. We can do this by comparing the Taylor series expansion of our approximation to the Taylor series expansion of \( y(t+h) \) and equating coefficients. Let&rsquo;s do this for the 2nd order method:</p>
<p>$$
y(t+h) \approx y(t) + w_1 k_1 + w_2 k_2
$$</p>
<p>As this is a 2nd order method, we will need to find the 2nd order expansions of the left and right sides.</p>
<p>Let&rsquo;s start with the left. The 2nd order Taylor series expansion of \( y(t+h) \) about \( t \) is:</p>
<p>$$
y(t+h) \approx y(t) + h \dfrac{dy}{dt} \Big| _{t,y} + \frac{h^2}{2} \dfrac{d^2y}{dt^2} \Big| _{t,y} + O(h^3)
$$</p>
<p>We can write our derivative:</p>
<p>$$
\dfrac{dy}{dt} = f(t, y)
\\
{}
\\
\dfrac{d^2y}{dt^2} = \dfrac{df(t,y)}{dt} = \dfrac{\partial f}{\partial t} + \dfrac{\partial f}{\partial y} \dfrac{dy}{dt} =
\dfrac{\partial f}{\partial t} + f \dfrac{\partial f}{\partial y}
$$</p>
<p>This makes our left hand side (using slightly different notation):</p>
<p>$$
y_{n+1} \approx y_n + h f(t_n, y_n) + \frac{h^2}{2}  \bigg(\dfrac{\partial f}{\partial t} + f \dfrac{\partial f}{\partial y}\bigg) \bigg|_{t_n, y_n} + O(h^3)
$$</p>
<p>Great! Let&rsquo;s do the right hand side now. We can write the right hand same with the same notation as above:</p>
<p>$$
y_n + w_1 k_{1,n} + w_2 k_{2,n}
$$</p>
<p>\( k_2 \) is a bit tricky to expand. Our \( k_2 \) term is made up mostly of a function with the form \( f(t + \Delta t, y + \Delta y) \), which will need to be expanded. In general, the 2nd order expansion looks like:</p>
<p>$$
f(t + \Delta t, y + \Delta y) = f(t, y) + \Delta t \dfrac{\partial f}{\partial t}\bigg| _{t, y} +
\Delta y \dfrac{\partial f}{\partial y} \bigg| _{t, y} + O(h^3)
$$</p>
<p>Applying this to \( k_2 \) gives:</p>
<p>$$
k_{2,n} = h f(t + \alpha_2 h, y_n + \beta_{2,1} k_1) \approx h \bigg( f(t_n, y_n) + \alpha _2 h \dfrac{\partial f}{\partial t} \bigg| _{t_n, y_n} +
\beta _{2,1} k_1 \dfrac{\partial f}{\partial y} \bigg| _{t_n, y_n} \bigg)
$$</p>
<p>All together, the right hand side is then</p>
<p>$$
y_n + w_1 k_{1,n} + w_2 k_{2,n} \approx y_n + w_1 h f(t_n, y_n) +
w_2 h \bigg( f(t_n, y_n) + \alpha _2 h \dfrac{\partial f}{\partial t} \bigg| _{t_n, y_n} +
\beta _{2,1} k_1 \dfrac{\partial f}{\partial y} \bigg| _{t_n, y_n} \bigg) + O(h^3)
$$</p>
<p>which we can rearrange to be in the same form (substituting in for \( k_1 \)) as the left hand side:</p>
<p>$$
y_n + w_1 k_{1,n} + w_2 k_{2,n} \approx
y_n + (w_1 + w_2) h f(t_n, y_n) + \frac{h^2}{2} \bigg(2 w_2 \alpha_2 \dfrac{\partial f}{\partial t} +
2 w_2 \beta _{2,1} f \dfrac{\partial f}{\partial y}  \bigg) \bigg| _{t_n, y_n} + O(h^3)
$$</p>
<p>Finally, we have both expansions and can equate the coefficients:</p>
<p>$$
y(t+h) \approx y(t) + w_1 k_1 + w_2 k_2
\\
{}
\\
\big\downarrow
\\
{}
\\
y_n + h f(t_n, y_n) + \frac{h^2}{2}  \bigg(\dfrac{\partial f}{\partial t} + f \dfrac{\partial f}{\partial y}\bigg) \bigg|_{t_n, y_n} + O(h^3)
\\ {} \\ = \\ {} \\
y_n + (w_1 + w_2) h f(t_n, y_n) + \frac{h^2}{2} \bigg(2 w_2 \alpha_2 \dfrac{\partial f}{\partial t} +
2 w_2 \beta _{2,1} f \dfrac{\partial f}{\partial y}  \bigg) \bigg| _{t_n, y_n} + O(h^3)
$$</p>
<p>From this, we can see that our coefficients must satisfy the following equations:</p>
<p>$$
w_1 + w_2 = 1 \\ {} \\
w_2 \alpha_2= \frac{1}{2} \\ {} \\
w_2 \beta_{2,1} = \frac{1}{2}
$$</p>
<p>With 3 equations and 4 unknows, there are infinitely many solutions. However, the standard choices are:</p>
<p>$$
\alpha_2 = \beta_{2,1} = 1
\\ {} \\
w_1 = w_2 = \frac{1}{2}
$$</p>
<p>This brings us <em>finally</em> to the complete <strong>2nd order Runge-Kutta Method</strong>:</p>
<p>$$
k_1 = h y^\prime (t_n, y_n)
\\ {} \\
k_2 = h y^\prime (t_n + h, y_n + k_1)
\\ {} \\
y_{n+1} = y_n + \frac{1}{2} k_1 + \frac{1}{2} k_2
$$</p>
<p>A similar (messier) method of expansions can be used to for higher order methods. The standard terms for the <strong>4th order Runge-Kutta method</strong> are:</p>
<p>$$
k_1 = h y^\prime (t_n, y_n)
\\ {} \\
k_2 = h y^\prime (t_n + \frac{h}{2}, y_n + \frac{k_1}{2})
\\ {} \\
k_3 = h y^\prime (t_n + \frac{h}{2}, y_n + \frac{k_2}{2})
\\ {} \\
k_4 = h y^\prime (t_n + h, y_n + k_3)
\\ {} \\
y_{n+1} = y_n + \frac{1}{6} (k_1 + 2 k_2 + 2 k_3 + k_4)
$$</p>
<p>Keep in mind that there are infinitely many choices of these coefficients and lots of research has gone into figuring out which ones work best. We will stick to these simple standard ones for now.</p>
<h4 id="implementing-runge-kutta">Implementing Runge-Kutta<a hidden class="anchor" aria-hidden="true" href="#implementing-runge-kutta">#</a></h4>
<p>Now that we have finally derived the Runge-Kutta methods, let&rsquo;s implement them in code. We will do both the 2nd order and 4th order methods and compare their accuracy.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="hl"><span class="lnt">20
</span></span><span class="hl"><span class="lnt">21
</span></span><span class="lnt">22
</span><span class="hl"><span class="lnt">23
</span></span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rk2</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Solves a first-order ODE using the 2nd order Runge-Kutta method
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The derivative function to integrate
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        t_end: Final time for integration
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        An array of y values for each time step
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>  <span class="c1"># Array of time points</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
</span></span><span class="line hl"><span class="cl">        <span class="n">k1</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line hl"><span class="cl">        <span class="n">k2</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can see how, at each time step, we calculate the \( k_i \) values and use these to estimate the next value of the function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="hl"><span class="lnt">20
</span></span><span class="hl"><span class="lnt">21
</span></span><span class="hl"><span class="lnt">22
</span></span><span class="hl"><span class="lnt">23
</span></span><span class="lnt">24
</span><span class="hl"><span class="lnt">25
</span></span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rk4</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Solves a first-order ODE using the 4th order Runge-Kutta method
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The derivative function to integrate
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        t_end: Final time for integration
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        An array of y values for each time step
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
</span></span><span class="line hl"><span class="cl">        <span class="n">k1</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line hl"><span class="cl">        <span class="n">k2</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line hl"><span class="cl">        <span class="n">k3</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line hl"><span class="cl">        <span class="n">k4</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k3</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k3</span> <span class="o">+</span> <span class="n">k4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After all that derivation, the actual method is remarkably clean and simple to implement. <strong>Figure 5</strong> gives an idea of how these higher order functions perform compared to our original Euler method.</p>
<figure class="align-center ">
    <img loading="lazy" src="../img/solver_comparison.png#center"
         alt="Figure 5: Comparing the accuracy of different order ODE solvers, h = 0.1"/> <figcaption>
            <p><strong>Figure 5</strong>: Comparing the accuracy of different order ODE solvers, h = 0.1</p>
        </figcaption>
</figure>

<p>All the solvers are using the same step size here. As we can see, the 4th order method is better than the 2nd order method. They are both much more accurate than the 1st order Euler method.</p>
<p>As a final comparison, let&rsquo;s look at Newton&rsquo;s law of cooling one last time. <strong>Figure 6</strong> shows how our 4th order solver compares to our previous test with the Euler method.</p>
<figure class="align-center ">
    <img loading="lazy" src="../img/rk4_cooling_eqn.png#center"
         alt="Figure 6: Comparing the accuracy of the RK4 and Euler methods on the cooling equation. Tsurr = 20 C, k = 1, h = 0.5"/> <figcaption>
            <p><strong>Figure 6</strong>: Comparing the accuracy of the RK4 and Euler methods on the cooling equation. T<sub>surr</sub> = 20 C, k = 1, h = 0.5</p>
        </figcaption>
</figure>



<p><details >
  <summary markdown="span">Figure 5 and 6 code</summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Implementing and comparing the Runge-Kutta 2nd and 4th order methods.
</span></span></span><span class="line"><span class="cl"><span class="s1">We can also compare to the Euler method (1st order).
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Created by: simmeon
</span></span></span><span class="line"><span class="cl"><span class="s1">Last Modified: 29/04/24
</span></span></span><span class="line"><span class="cl"><span class="s1">License: MIT
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define some functions to test our solvers with</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">t</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">analytical_solution</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>  <span class="c1"># Analytical solution to the ODE </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># # Define our cooling function</span>
</span></span><span class="line"><span class="cl"><span class="c1"># def solve_T(t, T0):</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     return T_surr + (T0 - T_surr)*np.exp(-k*t)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># # Define the derivative (only depends on the current temp, not time)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># def dTdt(T):</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     return -k * (T - T_surr)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">euler_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Solves a first-order ODE using the Euler method
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        t_end: Final time for integration
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        An array of y values for each time step
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rk2</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Solves a first-order ODE using the 2nd order Runge-Kutta method
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The derivative function to integrate
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        t_end: Final time for integration
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        An array of y values for each time step
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>  <span class="c1"># Array of time points</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">k1</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">k2</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rk4</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Solves a first-order ODE using the 4th order Runge-Kutta method
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The derivative function to integrate
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        t_end: Final time for integration
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        An array of y values for each time step
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">k1</span> <span class="o">=</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">k2</span> <span class="o">=</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k3</span> <span class="o">=</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k4</span> <span class="o">=</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k3</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k3</span> <span class="o">+</span> <span class="n">k4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">h</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define simulation parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">y0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">t_end</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="n">h</span> <span class="o">=</span> <span class="mf">0.1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Solve using both methods</span>
</span></span><span class="line"><span class="cl"><span class="n">y_euler</span> <span class="o">=</span> <span class="n">euler_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y_rk2</span> <span class="o">=</span> <span class="n">rk2</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y_rk4</span> <span class="o">=</span> <span class="n">rk4</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get analytical solution</span>
</span></span><span class="line"><span class="cl"><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>  <span class="c1"># Array of time points</span>
</span></span><span class="line"><span class="cl"><span class="n">y_analytical</span> <span class="o">=</span> <span class="n">analytical_solution</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Calculate errors</span>
</span></span><span class="line"><span class="cl"><span class="n">error_euler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_euler</span> <span class="o">-</span> <span class="n">y_analytical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">error_rk2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_rk2</span> <span class="o">-</span> <span class="n">y_analytical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">error_rk4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_rk4</span> <span class="o">-</span> <span class="n">y_analytical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plot the numerical solutions</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y_euler</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Euler&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y_rk2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;RK2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y_rk4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;RK4&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y_analytical</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Analytical&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (t)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y(t)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Numerical Solutions&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plot the errors</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">error_euler</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Euler&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">error_rk2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;RK2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">error_rk4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;RK4&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (t)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Abs Error&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Absolute Errors of the Numerical Solutions&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</details></p>

<p>Even with a relatively large step size, the 4th order method is still much better than the Euler method. In fact, we could make the step size even bigger and still have a solution that fell within some tiny tolerance.</p>
<p>But how can we choose a good value to make this step size? If we want to be as efficient as possible, each step would as large as it can be while staying within the tolerance we want&hellip;</p>
<h2 id="step-sizing">Step Sizing<a hidden class="anchor" aria-hidden="true" href="#step-sizing">#</a></h2>
<h3 id="constant-step-size-issues">Constant Step Size Issues<a hidden class="anchor" aria-hidden="true" href="#constant-step-size-issues">#</a></h3>
<p>Take the following function,</p>
<p>$$
y = \sin{(t^5)} \\ {} \\
\dfrac{dy}{dt} = 5t^4 \cos{(t^5)}
$$</p>
<p>We can use the derivative to solve for \( y \) using one of our numerical methods from earlier. <strong>Figure 7</strong> shows us doing this using the Euler method, along with the error in our solution.</p>
<figure class="align-center ">
    <img loading="lazy" src="../img/constant_step_size.png#center"
         alt="Figure 7: Euler method solution and error using a constant step size, h = 0.05."/> <figcaption>
            <p><strong>Figure 7</strong>: Euler method solution and error using a constant step size, h = 0.05.</p>
        </figcaption>
</figure>



<p><details >
  <summary markdown="span">Figure 7 code</summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Seeing how a constant step size numerical solver can have wildly varying 
</span></span></span><span class="line"><span class="cl"><span class="s1">error on diffrent steps.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Created by: simmeon
</span></span></span><span class="line"><span class="cl"><span class="s1">Last Modified: 18/05/24
</span></span></span><span class="line"><span class="cl"><span class="s1">License: MIT
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define function and its derivative</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">5</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">analytical_solution</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Our Euler numerical solver</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">euler_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Solves a first-order ODE using the Euler method
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        t_end: Final time for integration
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        An array of y values for each time step
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define simulation parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">y0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">t_end</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">h</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="c1"># we are using a constant step size here</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Numerically integrate</span>
</span></span><span class="line"><span class="cl"><span class="n">t_euler</span><span class="p">,</span> <span class="n">y_euler</span> <span class="o">=</span> <span class="n">euler_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get analytical solution</span>
</span></span><span class="line"><span class="cl"><span class="n">t_analytical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y_analytical</span> <span class="o">=</span> <span class="n">analytical_solution</span><span class="p">(</span><span class="n">t_analytical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get error</span>
</span></span><span class="line"><span class="cl"><span class="n">y_analytical_sampled</span> <span class="o">=</span> <span class="n">y_analytical</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">50</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_euler</span> <span class="o">-</span> <span class="n">y_analytical_sampled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plotting</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_analytical</span><span class="p">,</span> <span class="n">y_analytical</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Analytical&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_euler</span><span class="p">,</span> <span class="n">y_euler</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Euler method&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Error when integrating with a constant step size&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_euler</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;absolute error&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</details></p>

<p>The method works well initially when the function is changing slowly. However, when the function is changing more rapidly, our Euler method solver error gets large. You can try increasing the time to integrate over and see how the error becomes even bigger.</p>
<p>This is happening because our step size (\( h = 0.05 \)) becomes too large to properly capture how the function is changing. We could make our step size smaller, but we don&rsquo;t need that additional resolution for the start of the function, it&rsquo;s already pretty accurate.</p>
<h3 id="using-multiple-step-sizes">Using Multiple Step Sizes<a hidden class="anchor" aria-hidden="true" href="#using-multiple-step-sizes">#</a></h3>
<p>Instead of decreasing the step size for the entire integration period, it would be <em>much</em> more efficient if we could
just decrease it where we need to.</p>
<p>In this example, we could try switching to a smaller step size (say, \( h = 0.01 \)) after \( t = 1 \) when our solution starts getting less accurate. Doing this gives the solution shown in <strong>Figure 8</strong>.</p>
<figure class="align-center ">
    <img loading="lazy" src="../img/two_step_sizes.png#center"
         alt="Figure 8: Euler method solution and error using two step sizes: t &lt;= 1, h = 0.05; t &gt; 1, h = 0.01"/> <figcaption>
            <p><strong>Figure 8</strong>: Euler method solution and error using two step sizes: t &lt;= 1, h = 0.05; t &gt; 1, h = 0.01</p>
        </figcaption>
</figure>



<p><details >
  <summary markdown="span">Figure 8 code</summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Seeing how we can improve our solution and efficiency by using two different 
</span></span></span><span class="line"><span class="cl"><span class="s1">step sizes at different times.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Created by: simmeon
</span></span></span><span class="line"><span class="cl"><span class="s1">Last Modified: 18/05/24
</span></span></span><span class="line"><span class="cl"><span class="s1">License: MIT
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define function and its derivative</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">5</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">analytical_solution</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Our Euler numerical solver</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">euler_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Solves a first-order ODE using the Euler method
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        t_end: Final time for integration
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        An array of y values for each time step
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define simulation parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">y0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">t_end1</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">t_end2</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">h1</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="c1"># first, bigger step size</span>
</span></span><span class="line"><span class="cl"><span class="n">h2</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c1"># second. smaller step size</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Numerically integrate</span>
</span></span><span class="line"><span class="cl"><span class="n">t_euler1</span><span class="p">,</span> <span class="n">y_euler1</span> <span class="o">=</span> <span class="n">euler_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end1</span><span class="p">,</span> <span class="n">h1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">t_euler2</span><span class="p">,</span> <span class="n">y_euler2</span> <span class="o">=</span> <span class="n">euler_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t_end1</span><span class="p">,</span> <span class="n">y_euler1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t_end2</span><span class="p">,</span> <span class="n">h2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">y_euler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">y_euler1</span><span class="p">,</span> <span class="n">y_euler2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">t_euler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t_euler1</span><span class="p">,</span> <span class="n">t_euler2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get analytical solution</span>
</span></span><span class="line"><span class="cl"><span class="n">t_analytical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end2</span><span class="o">+</span><span class="n">h2</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y_analytical</span> <span class="o">=</span> <span class="n">analytical_solution</span><span class="p">(</span><span class="n">t_analytical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get error</span>
</span></span><span class="line"><span class="cl"><span class="n">y_analytical_compare</span> <span class="o">=</span> <span class="n">analytical_solution</span><span class="p">(</span><span class="n">t_euler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_euler</span> <span class="o">-</span> <span class="n">y_analytical_compare</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plotting</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_analytical</span><span class="p">,</span> <span class="n">y_analytical</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Analytical&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_euler</span><span class="p">,</span> <span class="n">y_euler</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Euler method&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">t_end1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Error when integrating with two different step sizes&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_euler</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">t_end1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;absolute error&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</details></p>

<p>This has made our solution around an order of magnitude more accurate. But how much computational complexity have we saved compared to just solving the entire time interval with the smaller step size? We can summarize this in <strong>Table 1</strong>.</p>
<p><strong>Table 1</strong></p>
<table>
  <thead>
      <tr>
          <th>Step size</th>
          <th style="text-align: right">Number of iteration steps</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>\( h = 0.05 \)</td>
          <td style="text-align: right">41</td>
      </tr>
      <tr>
          <td>\( t \leq 1, h = 0.05 \\ t&gt;1, h = 0.01\)</td>
          <td style="text-align: right">122</td>
      </tr>
      <tr>
          <td>\( h = 0.01 \)</td>
          <td style="text-align: right">201</td>
      </tr>
  </tbody>
</table>
<p>So we are saving a significant amount of computation compared to making the whole interval have a smaller step size.</p>
<p>Choosing to make the step size smaller at \( t = 1 \) was very arbitrary. We could also change the step size in more places &ndash; maybe making it even bigger initially and even smaller for \( t &gt; 1.5 \). We should come up with a smart way of choosing when and how to change the step size.</p>
<h3 id="adaptive-step-sizing">Adaptive Step Sizing<a hidden class="anchor" aria-hidden="true" href="#adaptive-step-sizing">#</a></h3>
<p>Since we want our solution to be accurate, it would be smart to decrease our step size when our error is getting too big. Also, to keep things efficient, we could make our step size bigger when the error is very small.</p>
<p>The issue is we don&rsquo;t have the actual solution, so how can we know what our error is?</p>
<p>We need to create some sort of &ldquo;true solution&rdquo; to compare our estimate against. One way we could do this is to use a higher order method, since we know that these should be more accurate and be closer to the actual solution. For example, if we want to use a 1st order Euler solver, we could also calculate a 2nd order Runge-Kutta solution and use that as the &ldquo;true solution&rdquo;.</p>
<p>So for every step, we will calculate the next step with two methods: a lower and higher order one. Then, we will use difference in these as our approximation of the error. From that, we can decide whether we should change the step size for the step or if it was ok.</p>
<p>The last thing to decide is how much we should change the step size. For now, a simple approach could be to halve the step size if the error was too big, and double it if it was too small.</p>
<p>More formally, we will:</p>
<ol>
<li>Take a step with the current step size using a 1st and 2nd order method.</li>
<li>Compare the solutions to approximate our error.</li>
<li>If the \( error &gt; tol \), reject the step, halve the step size, and go back to <strong>Step 1</strong>.</li>
<li>If the \( error &lt; tol \), accept the step and double the step size for the next step.</li>
</ol>
<p>In code this would look like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">euler_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Solves a first-order ODE using the Euler method with adaptive
</span></span></span><span class="line"><span class="cl"><span class="s2">    step sizing.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        t_end: Final time for integration
</span></span></span><span class="line"><span class="cl"><span class="s2">        tol: Error tolerance
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Arrays of y and t values for each time step
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">h</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># set some initial step size</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">t0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y_euler</span> <span class="o">=</span> <span class="p">[</span><span class="n">y0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y_rk2</span> <span class="o">=</span> <span class="p">[</span><span class="n">y0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t_end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Take a Euler step</span>
</span></span><span class="line"><span class="cl">        <span class="n">y_euler</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">euler_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Take a RK2 step, starting from the previous Euler step value</span>
</span></span><span class="line"><span class="cl">        <span class="n">y_rk2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rk2_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_rk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># accept step, make step size bigger for next step</span>
</span></span><span class="line"><span class="cl">            <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="ow">not</span> <span class="n">isStepGood</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Take a step with both methods</span>
</span></span><span class="line"><span class="cl">            <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">euler_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span>
</span></span><span class="line"><span class="cl">            <span class="n">y_rk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rk2_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Calculate the error between the methods</span>
</span></span><span class="line"><span class="cl">            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_rk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Check error to accept or reject the step</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># reject step, halve step size</span>
</span></span><span class="line"><span class="cl">                <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># accept step, make step size bigger for next step</span>
</span></span><span class="line"><span class="cl">                <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">y_euler</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><br>
If we use this to solve the same function as before, we get the solution shown in <strong>Figure 9</strong>.</p>
<figure class="align-center ">
    <img loading="lazy" src="../img/naive_adaptive_step.png#center"
         alt="Figure 9: Euler method solution and error with an adaptive step size, tol = 0.01."/> <figcaption>
            <p><strong>Figure 9</strong>: Euler method solution and error with an adaptive step size, tol = 0.01.</p>
        </figcaption>
</figure>



<p><details >
  <summary markdown="span">Figure 9 code</summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Implementing an adaptive step size by doubling or halving the step size 
</span></span></span><span class="line"><span class="cl"><span class="s1">depending on the error.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Created by: simmeon
</span></span></span><span class="line"><span class="cl"><span class="s1">Last Modified: 18/05/24
</span></span></span><span class="line"><span class="cl"><span class="s1">License: MIT
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define function and its derivative</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">5</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">analytical_solution</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">euler_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Takes a single 1st order integration step and returns the y value.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        The y value after the step.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rk2_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Takes a single 2nd order integration step and returns the y value.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        The y value after the step.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">k1</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k2</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">k1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Our adaptive Euler numerical solver</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">euler_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Solves a first-order ODE using the Euler method with adaptive
</span></span></span><span class="line"><span class="cl"><span class="s2">    step sizing.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        t_end: Final time for integration
</span></span></span><span class="line"><span class="cl"><span class="s2">        tol: Error tolerance
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Arrays of y, t and local error values for each time step
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">h</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># set some initial step size</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">t0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y_euler</span> <span class="o">=</span> <span class="p">[</span><span class="n">y0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y_rk2</span> <span class="o">=</span> <span class="p">[</span><span class="n">y0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t_end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Take a Euler step</span>
</span></span><span class="line"><span class="cl">        <span class="n">y_euler</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">euler_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Take a RK2 step, starting from the previous Euler step value</span>
</span></span><span class="line"><span class="cl">        <span class="n">y_rk2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rk2_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_rk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># accept step, make step size bigger for next step</span>
</span></span><span class="line"><span class="cl">            <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="ow">not</span> <span class="n">isStepGood</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Take a step with both methods</span>
</span></span><span class="line"><span class="cl">            <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">euler_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span>
</span></span><span class="line"><span class="cl">            <span class="n">y_rk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rk2_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Calculate the error between the methods</span>
</span></span><span class="line"><span class="cl">            <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_rk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Check error to accept or reject the step</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># reject step, halve step size</span>
</span></span><span class="line"><span class="cl">                <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># accept step, make step size bigger for next step</span>
</span></span><span class="line"><span class="cl">                <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">y_euler</span><span class="p">,</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define simulation parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">y0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">t_end</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Numerically integrate</span>
</span></span><span class="line"><span class="cl"><span class="n">t_euler</span><span class="p">,</span> <span class="n">y_euler</span><span class="p">,</span> <span class="n">local_error</span> <span class="o">=</span> <span class="n">euler_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">t_euler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_euler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y_euler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_euler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get analytical solution</span>
</span></span><span class="line"><span class="cl"><span class="n">t_analytical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y_analytical</span> <span class="o">=</span> <span class="n">analytical_solution</span><span class="p">(</span><span class="n">t_analytical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get error</span>
</span></span><span class="line"><span class="cl"><span class="n">y_analytical_compare</span> <span class="o">=</span> <span class="n">analytical_solution</span><span class="p">(</span><span class="n">t_euler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_euler</span> <span class="o">-</span> <span class="n">y_analytical_compare</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plotting</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_analytical</span><span class="p">,</span> <span class="n">y_analytical</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Analytical&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_euler</span><span class="p">,</span> <span class="n">y_euler</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Euler method&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_euler</span><span class="p">,</span> <span class="n">y_euler</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Integrating with a adaptive step size, tol = 0.01&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;Number of steps: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">t_euler</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_euler</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;absolute error&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_euler</span><span class="p">,</span> <span class="n">local_error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;local step error&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</details></p>

<p>Each dot represents where a step was taken. We can see how the step size is bigger when the function is changing slowly and smaller when the function changes quickly.</p>
<p>The error is interesting. We set a tolerance of \( 0.01 \) but the absolute error gets up to nearly \( 0.1 \). This is because the tolerance is used to set the allowable error <strong>for each step</strong>, not the overall (or global) error. Another reason is that our error is an estimate but here we are plotting against the actual, analytical error. Howveer, looking at the local error for each step we can see that it never gets above our tolerance.</p>
<h3 id="choosing-better-step-size-changes">Choosing Better Step Size Changes<a hidden class="anchor" aria-hidden="true" href="#choosing-better-step-size-changes">#</a></h3>
<p>We used a very simple method of halving the step size if the error was too big or doubling the step size if the error was too small. For the 255 steps we ended up with, the method calculated the next step 746 times. This means that, on average for each step, we changed the step size 2.9 times before finding a value that worked. There is a lot of computation that is wasted there.</p>
<p>Let&rsquo;s try and come up with a better way of choosing the step size to hopefully make our method more efficient.</p>
<p><em><strong>This will depend on what order methods we are using.</strong></em></p>
<p>We will start by doing this for the 1st order Euler method. We write this as:</p>
<p>$$
y_{n+1} = y_{n} + h \dfrac{dy}{dt} \bigg| _{t_n, y_n} + O(h^2)
$$</p>
<p>The error in our estimate is proportional to \( h^2 \). If we assume that this error is constant over time, we can say</p>
<p>$$
error = \Delta = c h^2
$$</p>
<p>where \( c \) is some constant value. Then, for some step size, \( h_1 \), we would get</p>
<p>$$
\Delta _1 = c h_1^2
$$</p>
<p>We could also write an equation for what the step size would have to be to get an error equal to our tolerance. Let&rsquo;s call this error \( \Delta _0 \).</p>
<p>$$
\Delta _0 = c h_0^2
$$</p>
<p>This \( h_0 \) is the value that we would want to use for the current step size to. In other words, it will give the largest step that stays within our tolerance.</p>
<p>We can use these two equations together through the constant \( c \) to get the relation:</p>
<p>$$
\frac{\Delta_1}{h_1^2} = \frac{\Delta_0}{h_0^2}
$$</p>
<p>This can then be arranged to solve for what our step size \( h_0 \) should be</p>
<p>$$
h_0 = h_1 \bigg(\frac{\Delta _0}{\Delta _1} \bigg) ^{0.5}
$$</p>
<p>or in more familiar notation</p>
<p>$$
h_{new} = h_{current} \bigg(\frac{tol}{error} \bigg) ^{0.5}
$$</p>
<p>In theory, using this formula should mean that we get the correct step size in one iteration instead of two or three. However, in practice, our error is only an approximation and so we should put in a safety factor to make the new step size slightly smaller that the theoretical value:</p>
<p>$$
h_{new} = 0.9 h_{current} \bigg(\frac{tol}{error} \bigg) ^{0.5}
$$</p>
<p>Let&rsquo;s use this instead of our doubling and halving approach and see how many calculations we use. Note that formula has the correct behaviour for errors that are both larger and smaller than the tolerance. We can see the result in <strong>Figure 10</strong>.</p>
<figure class="align-center ">
    <img loading="lazy" src="../img/better_adaptive_step.png#center"
         alt="Figure 10: Euler method solution and error with a better adaptive step size, tol = 0.01."/> <figcaption>
            <p><strong>Figure 10</strong>: Euler method solution and error with a better adaptive step size, tol = 0.01.</p>
        </figcaption>
</figure>



<p><details >
  <summary markdown="span">Figure 10 code</summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Implementing an adaptive step size with better step sizing.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Created by: simmeon
</span></span></span><span class="line"><span class="cl"><span class="s1">Last Modified: 19/05/24
</span></span></span><span class="line"><span class="cl"><span class="s1">License: MIT
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define function and its derivative</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">5</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">analytical_solution</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">euler_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Takes a single 1st order integration step and returns the y value.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        The y value after the step.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rk2_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Takes a single 2nd order integration step and returns the y value.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        The y value after the step.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">k1</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k2</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">k1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Our adaptive Euler numerical solver</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">euler_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Solves a first-order ODE using the Euler method with adaptive
</span></span></span><span class="line"><span class="cl"><span class="s2">    step sizing.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        t_end: Final time for integration
</span></span></span><span class="line"><span class="cl"><span class="s2">        tol: Error tolerance
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Arrays of y, t and local error values for each time step
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">h</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># set some initial step size</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">t0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y_euler</span> <span class="o">=</span> <span class="p">[</span><span class="n">y0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y_rk2</span> <span class="o">=</span> <span class="p">[</span><span class="n">y0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t_end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Take a Euler step</span>
</span></span><span class="line"><span class="cl">        <span class="n">y_euler</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">euler_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Take a RK2 step, starting from the previous Euler step value</span>
</span></span><span class="line"><span class="cl">        <span class="n">y_rk2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rk2_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_rk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># accept step, make step size bigger for next step</span>
</span></span><span class="line"><span class="cl">            <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">tol</span> <span class="o">/</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="ow">not</span> <span class="n">isStepGood</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Take a step with both methods</span>
</span></span><span class="line"><span class="cl">            <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">euler_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span>
</span></span><span class="line"><span class="cl">            <span class="n">y_rk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rk2_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Calculate the error between the methods</span>
</span></span><span class="line"><span class="cl">            <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_rk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_euler</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Check error to accept or reject the step</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># reject step, halve step size</span>
</span></span><span class="line"><span class="cl">                <span class="n">h</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">tol</span> <span class="o">/</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># accept step, make step size bigger for next step</span>
</span></span><span class="line"><span class="cl">                <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="n">h</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">tol</span> <span class="o">/</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Count: &#34;</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">y_euler</span><span class="p">,</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define simulation parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">y0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">t_end</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Numerically integrate</span>
</span></span><span class="line"><span class="cl"><span class="n">t_euler</span><span class="p">,</span> <span class="n">y_euler</span><span class="p">,</span> <span class="n">local_error</span> <span class="o">=</span> <span class="n">euler_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">t_euler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_euler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y_euler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_euler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get analytical solution</span>
</span></span><span class="line"><span class="cl"><span class="n">t_analytical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y_analytical</span> <span class="o">=</span> <span class="n">analytical_solution</span><span class="p">(</span><span class="n">t_analytical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get error</span>
</span></span><span class="line"><span class="cl"><span class="n">y_analytical_compare</span> <span class="o">=</span> <span class="n">analytical_solution</span><span class="p">(</span><span class="n">t_euler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_euler</span> <span class="o">-</span> <span class="n">y_analytical_compare</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plotting</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_analytical</span><span class="p">,</span> <span class="n">y_analytical</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Analytical&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_euler</span><span class="p">,</span> <span class="n">y_euler</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Euler method&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_euler</span><span class="p">,</span> <span class="n">y_euler</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Integrating with a adaptive step size, tol = 0.01&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;Number of steps: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">t_euler</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_euler</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;absolute error&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_euler</span><span class="p">,</span> <span class="n">local_error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;local step error&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</details></p>

<p>This change used 216 steps with a total of 323 step calulations, meaning we changed the step size 1.5 times per step. This is much closer to the minimum of 1 change per step. It also ended up requiring less steps than previously, being even more efficient.</p>
<p>This step change formula we created can be applied to higher order methods, for example if we were using a 4th order method with 5th order errors we would use:</p>
<p>$$
h_{new} = 0.9 h_{current} \bigg(\frac{tol}{error} \bigg) ^{\frac{1}{5}}
$$</p>
<h2 id="a-full-rk45-method">A Full RK45 Method<a hidden class="anchor" aria-hidden="true" href="#a-full-rk45-method">#</a></h2>
<p>Finally, we have all the parts to create a working 4th order Runge-Kutta numerical solver with adaptive step sizing based on 5th order errors.</p>
<p>We will start by writing a function that takes a single 5th order step. We are going to use the 5th order step to approximate our &ldquo;true solution&rdquo; and compare it to the 4th order step to find our error. The function will then return the 4th order step and the error. One reason this method is so good is because calculating the 5th step reuses a lot of the RK4 step calculations, making it very efficient.</p>
<p>To do this we will be using the Dormand-Prince coefficients. These are much messier than the standard coefficients we used before. However, they are very good at minimising the error in the 5th order approximation, which is exactly what we want &ndash; we want that 5th order approximation to be as close to the real solution as possible.</p>
<p>The intermediate approximations are calculated as follows:</p>
<p>$$
\begin{aligned}
&amp;k_1 = hf(t_n, y_n)
\\ {} \\
&amp;k_2 = hf \Big(t_n + \frac{1}{5}h, y_n + \frac{1}{5} k_1 \Big)
\\ {} \\
&amp;k_3 = hf \Big(t_n + \frac{3}{10}h, y_n + \frac{3}{40} k_1 + \frac{9}{40} k_2 \Big)
\\ {} \\
&amp;k_4 = hf \Big(t_n + \frac{4}{5}h, y_n + \frac{44}{45} k_1 - \frac{56}{15} k_2 + \frac{32}{9} k_3 \Big)
\\ {} \\
&amp;k_5 = hf \Big(t_n + \frac{8}{9}h, y_n + \frac{19372}{6561} k_1 - \frac{25360}{2187} k_2 + \frac{64448}{6561} k_3 - \frac{212}{729} k_4 \Big)
\\ {} \\
&amp;k_6 = hf \Big(t_n + h, y_n + \frac{9017}{3168} k_1 - \frac{355}{33} k_2 - \frac{46732}{5247} k_3 + \frac{49}{176} k_4 - \frac{5103}{18656} k_5 \Big)
\\ {} \\
&amp;k_7 = hf \Big(t_n + h, y_n + \frac{35}{848} k_1 + \frac{500}{1113} k_3 + \frac{125}{192} k_4 - \frac{2187}{6784} k_5 + \frac{11}{84} k_6 \Big)
\end{aligned}
$$</p>
<p>Then, the next 4th order step is calculated as</p>
<p>$$
y_{n+1} = y_n + \frac{35}{384} k_1 + \frac{500}{1113} k_3 + \frac{125}{192} k_4 - \frac{2187}{6784} k_5 + \frac{11}{84} k_6
$$</p>
<p>Note that these are the same coefficients that we use for \( k_7 \), which is useful. We can rewrite \( k_7 \) as</p>
<p>$$
k_7 = hf \Big( t_n + h, y_{n+1} \Big)
$$</p>
<p>This value is then the same as \( k_1 \) will be in the next step (except for \( h \) changing). This means that, except for the first step, we only have to calculate 6 derivatives per step.</p>
<p>Then, the 5th order step, \( z_{n+1} \), is calculated as</p>
<p>$$
z_{n+1} = y_n + \frac{5179}{57600} k_1 + \frac{7571}{16695} k_3 + \frac{393}{640} k_4 - \frac{92097}{339200} k_5 + \frac{187}{2100} k_6 + \frac{1}{40} k_7
$$</p>
<p>This gives the error</p>
<p>$$
error = \Big| z_{n+1} - y_{n+1} \Big| = \Big| -\frac{71}{57600} k_1 + \frac{71}{16695} k_3 - \frac{71}{1920} k_4 + \frac{17253}{339200} k_5 - \frac{22}{525} k_6 + \frac{1}{40} k_7 \Big|
$$</p>
<p>and from earlier we know that our step size change will be</p>
<p>$$
h_{new} = 0.9 h_{current} \bigg(\frac{tol}{error} \bigg) ^{0.2}
$$</p>
<p>Let&rsquo;s write this step function now, along with the function that adaptively steps to return the solution.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># ----- Dormand-Prince coefficients ----- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Alpha in notation, coefficients describe what percentage of the full</span>
</span></span><span class="line"><span class="cl"><span class="c1"># step we evaluate each derivative at</span>
</span></span><span class="line"><span class="cl"><span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Beta in notation, coefficients describe how much of each previous change in y</span>
</span></span><span class="line"><span class="cl"><span class="c1"># we add to the current estimate</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">3</span><span class="o">/</span><span class="mi">40</span><span class="p">,</span> <span class="mi">9</span><span class="o">/</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">44</span><span class="o">/</span><span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">56</span><span class="o">/</span><span class="mi">15</span><span class="p">,</span> <span class="mi">32</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">19372</span><span class="o">/</span><span class="mi">6561</span><span class="p">,</span> <span class="o">-</span><span class="mi">25360</span><span class="o">/</span><span class="mi">2187</span><span class="p">,</span> <span class="mi">64448</span><span class="o">/</span><span class="mi">6561</span><span class="p">,</span> <span class="o">-</span><span class="mi">212</span><span class="o">/</span><span class="mi">729</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">9017</span><span class="o">/</span><span class="mi">3168</span><span class="p">,</span> <span class="o">-</span><span class="mi">355</span><span class="o">/</span><span class="mi">33</span><span class="p">,</span> <span class="mi">46732</span><span class="o">/</span><span class="mi">5247</span><span class="p">,</span> <span class="mi">49</span><span class="o">/</span><span class="mi">176</span><span class="p">,</span> <span class="o">-</span><span class="mi">5103</span><span class="o">/</span><span class="mi">18656</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">35</span><span class="o">/</span><span class="mi">384</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="o">/</span><span class="mi">1113</span><span class="p">,</span> <span class="mi">125</span><span class="o">/</span><span class="mi">192</span><span class="p">,</span> <span class="o">-</span><span class="mi">2187</span><span class="o">/</span><span class="mi">6784</span><span class="p">,</span> <span class="mi">11</span><span class="o">/</span><span class="mi">84</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Weighting for each derivative in the approximation, w in notation</span>
</span></span><span class="line"><span class="cl"><span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">35</span><span class="o">/</span><span class="mi">384</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="o">/</span><span class="mi">1113</span><span class="p">,</span> <span class="mi">125</span><span class="o">/</span><span class="mi">192</span><span class="p">,</span> <span class="o">-</span><span class="mi">2187</span><span class="o">/</span><span class="mi">6784</span><span class="p">,</span> <span class="mi">11</span><span class="o">/</span><span class="mi">84</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="c1">#W = np.array([5179/57600, 0, 7571/16695, 393/640, -92097/339200, 187/2100, 1/40])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Coefficients for error calculation</span>
</span></span><span class="line"><span class="cl"><span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">71</span><span class="o">/</span><span class="mi">57600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">71</span><span class="o">/</span><span class="mi">16695</span><span class="p">,</span> <span class="o">-</span><span class="mi">71</span><span class="o">/</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">17253</span><span class="o">/</span><span class="mi">339200</span><span class="p">,</span> <span class="o">-</span><span class="mi">22</span><span class="o">/</span><span class="mi">525</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">40</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ------------------------------------------------------------------ #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define a function to take a single RK45 step</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rk45_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Takes a single 5th order integration step and returns the 
</span></span></span><span class="line"><span class="cl"><span class="s2">    4th order step along with the 5th order error.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        The the 4th order y value along with the 5th order error.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">k1</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k2</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k3</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k4</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k5</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">k4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k6</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">k4</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">k5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">k4</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">k5</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">k6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">k7</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">k4</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">k5</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">k6</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">k7</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define the full RK45 solver function</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rk45_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Solves a first-order ODE using the RK45 method.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        t_end: Final time for integration
</span></span></span><span class="line"><span class="cl"><span class="s2">        tol: Error tolerance
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Arrays of y, t and local error values for each time step
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">h</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="c1"># set some initial step size</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">t0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">y0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t_end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Take a step</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y_step</span><span class="p">,</span> <span class="n">error_step</span> <span class="o">=</span> <span class="n">rk45_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_step</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_step</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Update step size after step</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">tol</span> <span class="o">/</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># accept step</span>
</span></span><span class="line"><span class="cl">            <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="ow">not</span> <span class="n">isStepGood</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># If there was too much error...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Take a step</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="c1"># update our time value with the new step size</span>
</span></span><span class="line"><span class="cl">            <span class="n">y_step</span><span class="p">,</span> <span class="n">error_step</span> <span class="o">=</span> <span class="n">rk45_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_step</span>
</span></span><span class="line"><span class="cl">            <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_step</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Update step size after step</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">tol</span> <span class="o">/</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Check error to accept or reject the step</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">error</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><br>
Using this step function along with updating the step size gives the result in <strong>Figure 11</strong>.</p>
<figure class="align-center ">
    <img loading="lazy" src="../img/rk45.png#center"
         alt="Figure 11: RK45 Solver with error."/> <figcaption>
            <p><strong>Figure 11</strong>: RK45 Solver with error.</p>
        </figcaption>
</figure>



<p><details >
  <summary markdown="span">Figure 11 code (<em><strong>full solver code + graphing</strong></em>)</summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Implementing a complete RK45 algorithm.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Created by: simmeon
</span></span></span><span class="line"><span class="cl"><span class="s1">Last Modified: 19/05/24
</span></span></span><span class="line"><span class="cl"><span class="s1">License: MIT
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define function (for analytical solution) and its derivative</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dydt</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">5</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">analytical_solution</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ----- Dormand-Prince coefficients ----- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Alpha in notation, coefficients describe what percentage of the full</span>
</span></span><span class="line"><span class="cl"><span class="c1"># step we evaluate each derivative at</span>
</span></span><span class="line"><span class="cl"><span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Beta in notation, coefficients describe how much of each previous change in y</span>
</span></span><span class="line"><span class="cl"><span class="c1"># we add to the current estimate</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">3</span><span class="o">/</span><span class="mi">40</span><span class="p">,</span> <span class="mi">9</span><span class="o">/</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">44</span><span class="o">/</span><span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">56</span><span class="o">/</span><span class="mi">15</span><span class="p">,</span> <span class="mi">32</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">19372</span><span class="o">/</span><span class="mi">6561</span><span class="p">,</span> <span class="o">-</span><span class="mi">25360</span><span class="o">/</span><span class="mi">2187</span><span class="p">,</span> <span class="mi">64448</span><span class="o">/</span><span class="mi">6561</span><span class="p">,</span> <span class="o">-</span><span class="mi">212</span><span class="o">/</span><span class="mi">729</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">9017</span><span class="o">/</span><span class="mi">3168</span><span class="p">,</span> <span class="o">-</span><span class="mi">355</span><span class="o">/</span><span class="mi">33</span><span class="p">,</span> <span class="mi">46732</span><span class="o">/</span><span class="mi">5247</span><span class="p">,</span> <span class="mi">49</span><span class="o">/</span><span class="mi">176</span><span class="p">,</span> <span class="o">-</span><span class="mi">5103</span><span class="o">/</span><span class="mi">18656</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">35</span><span class="o">/</span><span class="mi">384</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="o">/</span><span class="mi">1113</span><span class="p">,</span> <span class="mi">125</span><span class="o">/</span><span class="mi">192</span><span class="p">,</span> <span class="o">-</span><span class="mi">2187</span><span class="o">/</span><span class="mi">6784</span><span class="p">,</span> <span class="mi">11</span><span class="o">/</span><span class="mi">84</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Weighting for each derivative in the approximation, w in notation</span>
</span></span><span class="line"><span class="cl"><span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">35</span><span class="o">/</span><span class="mi">384</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="o">/</span><span class="mi">1113</span><span class="p">,</span> <span class="mi">125</span><span class="o">/</span><span class="mi">192</span><span class="p">,</span> <span class="o">-</span><span class="mi">2187</span><span class="o">/</span><span class="mi">6784</span><span class="p">,</span> <span class="mi">11</span><span class="o">/</span><span class="mi">84</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="c1">#W = np.array([5179/57600, 0, 7571/16695, 393/640, -92097/339200, 187/2100, 1/40])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Coefficients for error calculation</span>
</span></span><span class="line"><span class="cl"><span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">71</span><span class="o">/</span><span class="mi">57600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">71</span><span class="o">/</span><span class="mi">16695</span><span class="p">,</span> <span class="o">-</span><span class="mi">71</span><span class="o">/</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">17253</span><span class="o">/</span><span class="mi">339200</span><span class="p">,</span> <span class="o">-</span><span class="mi">22</span><span class="o">/</span><span class="mi">525</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">40</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ------------------------------------------------------------------ #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define a function to take a single RK45 step</span>
</span></span><span class="line"><span class="cl"><span class="c1"># To improve efficiency, k7 could be reused as k1 in the following step</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rk45_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Takes a single 5th order integration step and returns the 
</span></span></span><span class="line"><span class="cl"><span class="s2">    4th order step along with the 5th order error.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        The the 4th order y value along with the 5th order error.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">k1</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k2</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k3</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k4</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k5</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">k4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k6</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">k4</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">k5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">k4</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">k5</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">k6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">k7</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">k4</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">k5</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">k6</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">k7</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define the full RK45 solver function</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rk45_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Solves a first-order ODE using the RK45 method.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        t_end: Final time for integration
</span></span></span><span class="line"><span class="cl"><span class="s2">        tol: Error tolerance
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Arrays of y, t and local error values for each time step
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">h</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="c1"># set some initial step size</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">t0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">y0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t_end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Take a step</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y_step</span><span class="p">,</span> <span class="n">error_step</span> <span class="o">=</span> <span class="n">rk45_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_step</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_step</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Update step size after step</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">tol</span> <span class="o">/</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># accept step</span>
</span></span><span class="line"><span class="cl">            <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="ow">not</span> <span class="n">isStepGood</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># If there was too much error...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Take a step</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="c1"># update our time value with the new step size</span>
</span></span><span class="line"><span class="cl">            <span class="n">y_step</span><span class="p">,</span> <span class="n">error_step</span> <span class="o">=</span> <span class="n">rk45_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_step</span>
</span></span><span class="line"><span class="cl">            <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_step</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Update step size after step</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">tol</span> <span class="o">/</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Check error to accept or reject the step</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define simulation parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">y0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">t_end</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Numerically integrate</span>
</span></span><span class="line"><span class="cl"><span class="n">t_rk45</span><span class="p">,</span> <span class="n">y_rk45</span><span class="p">,</span> <span class="n">local_error</span> <span class="o">=</span> <span class="n">rk45_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">t_rk45</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_rk45</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y_rk45</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_rk45</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get analytical solution</span>
</span></span><span class="line"><span class="cl"><span class="n">t_analytical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y_analytical</span> <span class="o">=</span> <span class="n">analytical_solution</span><span class="p">(</span><span class="n">t_analytical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get error</span>
</span></span><span class="line"><span class="cl"><span class="n">y_analytical_compare</span> <span class="o">=</span> <span class="n">analytical_solution</span><span class="p">(</span><span class="n">t_rk45</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_rk45</span> <span class="o">-</span> <span class="n">y_analytical_compare</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plotting</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_analytical</span><span class="p">,</span> <span class="n">y_analytical</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Analytical&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rk45</span><span class="p">,</span> <span class="n">y_rk45</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;RK45 method&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#plt.scatter(t_rk45, y_rk45, s=30, marker=&#39;o&#39;, facecolors=&#39;none&#39;, color=&#39;C1&#39;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;RK45 Solver, tol = </span><span class="si">{</span><span class="n">tol</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;Number of steps: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">t_rk45</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rk45</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;absolute error&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rk45</span><span class="p">,</span> <span class="n">local_error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;local step error&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</details></p>

<p>As we can see, the method is incredibly efficient and accurate. In comparison, our 1st order adaptive method used over 200 steps for a tolerance of only 1e-03. This combination of efficiency and accuracy makes the RK45 method an incredibly good general solver.</p>
<h2 id="a-final-application">A Final Application<a hidden class="anchor" aria-hidden="true" href="#a-final-application">#</a></h2>
<p>So far we have used mostly trivial or contrived examples to demonstrate why the RK45 solver is good. To finish off, we will use a real-world example where the adaptability, efficiency, and accuracy of the RK45 solver is very useful.</p>
<p>We will be using the solver to propagate a satellite orbit around the earth. We will skip some details of deriving the relevant physics, but the important equation is:</p>
<p>$$
F = \frac{G m_{earth} m_{sat}}{r^2}
$$</p>
<p>Let&rsquo;s define the gravitational parameter, \( \mu \)</p>
<p>$$
\mu = G(m_{earth} + m_{sat})
$$</p>
<p>By assuming an inertial reference frame centred on the Earth, we get</p>
<p>$$
\ddot{\vec{r}} = - \frac{G(m_{earth} + m_{sat})}{r^3}\vec{r}
\\ {} \\
\ddot{\vec{r}} = - \frac{\mu}{r^3}\vec{r}
$$</p>
<p>where \( \vec{r} \) is the position vector of the satellite we want to solve for.</p>
<p>This is currently a second order ODE. We can use a state space to transform it into being first order:</p>
<p>$$
\bold{x} = \begin{bmatrix}
r_x \\
r_y \\
\dot{r}_x \\
\dot{r}_y
\end{bmatrix}
\\ {} \\ {} \\
\bold{\dot{x}} = \begin{bmatrix}
\dot{r}_x \\ {} \\
\dot{r}_y \\ {} \\
\ddot{r}_x \\ {} \\
\ddot{r}_y \\
\end{bmatrix} = \begin{bmatrix}
\dot{r}_x \\ {} \\
\dot{r}_y \\ {} \\
-\Large \frac{\mu r_x}{|r|^3} \\ {} \\
-\Large \frac{\mu r_y}{|r|^3} \\
\end{bmatrix}
\\ {} \\ {} \\
\bold{\dot{x}} = \begin{bmatrix}
0 &amp; 0 &amp; 1 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 1 \\
-\Large \frac{\mu}{|r|^3} &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; -\Large \frac{\mu}{|r|^3} &amp; 0 &amp; 0
\end{bmatrix} \bold{x}
$$</p>
<p>This is now a system of first order ODEs where we are solving for \( \bold{x} \). With some small code changes to allow for vector inputs, <strong>Figure 12</strong> shows the resulting satellite position and velocity for some initial state. To deal with multiple ODE systems with arrays of solutions instead of just a single value, we use the maximum error as our test for whether the step was good or not.</p>
<figure class="align-center ">
    <img loading="lazy" src="../img/orbit.png#center"
         alt="Figure 12: Propagating an orbit with RK45."/> <figcaption>
            <p><strong>Figure 12</strong>: Propagating an orbit with RK45.</p>
        </figcaption>
</figure>



<p><details >
  <summary markdown="span">Figure 12 code</summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">An application of the RK45 ODE solver. We will solve for the position
</span></span></span><span class="line"><span class="cl"><span class="s1">of a satellite around Earth given an initial position and velocity.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Created by: simmeon
</span></span></span><span class="line"><span class="cl"><span class="s1">Last Modified: 19/05/24
</span></span></span><span class="line"><span class="cl"><span class="s1">License: MIT
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;https://github.com/dhaitz/matplotlib-stylesheets/raw/master/pitayasmoothie-dark.mplstyle&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define derivative</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dxdt</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">mu</span> <span class="o">=</span> <span class="mf">398600.4415</span><span class="p">;</span>   <span class="c1"># [km^3 / (kg*s^2)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">-</span><span class="n">mu</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">r_mag</span><span class="o">**</span><span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="n">mu</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">r_mag</span><span class="o">**</span><span class="mi">3</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ----- Dormand-Prince coefficients ----- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Alpha in notation, coefficients describe what percentage of the full</span>
</span></span><span class="line"><span class="cl"><span class="c1"># step we evaluate each derivative at</span>
</span></span><span class="line"><span class="cl"><span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Beta in notation, coefficients describe how much of each previous change in y</span>
</span></span><span class="line"><span class="cl"><span class="c1"># we add to the current estimate</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">3</span><span class="o">/</span><span class="mi">40</span><span class="p">,</span> <span class="mi">9</span><span class="o">/</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">44</span><span class="o">/</span><span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">56</span><span class="o">/</span><span class="mi">15</span><span class="p">,</span> <span class="mi">32</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">19372</span><span class="o">/</span><span class="mi">6561</span><span class="p">,</span> <span class="o">-</span><span class="mi">25360</span><span class="o">/</span><span class="mi">2187</span><span class="p">,</span> <span class="mi">64448</span><span class="o">/</span><span class="mi">6561</span><span class="p">,</span> <span class="o">-</span><span class="mi">212</span><span class="o">/</span><span class="mi">729</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">9017</span><span class="o">/</span><span class="mi">3168</span><span class="p">,</span> <span class="o">-</span><span class="mi">355</span><span class="o">/</span><span class="mi">33</span><span class="p">,</span> <span class="mi">46732</span><span class="o">/</span><span class="mi">5247</span><span class="p">,</span> <span class="mi">49</span><span class="o">/</span><span class="mi">176</span><span class="p">,</span> <span class="o">-</span><span class="mi">5103</span><span class="o">/</span><span class="mi">18656</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="mi">35</span><span class="o">/</span><span class="mi">384</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="o">/</span><span class="mi">1113</span><span class="p">,</span> <span class="mi">125</span><span class="o">/</span><span class="mi">192</span><span class="p">,</span> <span class="o">-</span><span class="mi">2187</span><span class="o">/</span><span class="mi">6784</span><span class="p">,</span> <span class="mi">11</span><span class="o">/</span><span class="mi">84</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Weighting for each derivative in the approximation, w in notation</span>
</span></span><span class="line"><span class="cl"><span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">35</span><span class="o">/</span><span class="mi">384</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="o">/</span><span class="mi">1113</span><span class="p">,</span> <span class="mi">125</span><span class="o">/</span><span class="mi">192</span><span class="p">,</span> <span class="o">-</span><span class="mi">2187</span><span class="o">/</span><span class="mi">6784</span><span class="p">,</span> <span class="mi">11</span><span class="o">/</span><span class="mi">84</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="c1">#W = np.array([5179/57600, 0, 7571/16695, 393/640, -92097/339200, 187/2100, 1/40])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Coefficients for error calculation</span>
</span></span><span class="line"><span class="cl"><span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">71</span><span class="o">/</span><span class="mi">57600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">71</span><span class="o">/</span><span class="mi">16695</span><span class="p">,</span> <span class="o">-</span><span class="mi">71</span><span class="o">/</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">17253</span><span class="o">/</span><span class="mi">339200</span><span class="p">,</span> <span class="o">-</span><span class="mi">22</span><span class="o">/</span><span class="mi">525</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">40</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ------------------------------------------------------------------ #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define a function to take a single RK45 step</span>
</span></span><span class="line"><span class="cl"><span class="c1"># To improve efficiency, k7 can be reused as k1 in the following step</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rk45_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Takes a single 5th order integration step and returns the 
</span></span></span><span class="line"><span class="cl"><span class="s2">    4th order step along with the 5th order error.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        h: Step size
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        The the 4th order y value along with the 5th order error.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">k1</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k2</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k3</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k4</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k5</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">k4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k6</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">k4</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">k5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">k4</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">k5</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">k6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">k7</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dydt</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">k4</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">k5</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">k6</span> <span class="o">+</span> <span class="n">E</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">k7</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define the full RK45 solver function</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rk45_solver</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Solves a first-order ODE using the RK45 method.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dydt: The differential equation (dy/dt) as a Python function 
</span></span></span><span class="line"><span class="cl"><span class="s2">        t0: Initial value of time
</span></span></span><span class="line"><span class="cl"><span class="s2">        y0: Initial value of y
</span></span></span><span class="line"><span class="cl"><span class="s2">        t_end: Final time for integration
</span></span></span><span class="line"><span class="cl"><span class="s2">        tol: Error tolerance
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Arrays of y, t and local error values for each time step
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">h</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="c1"># set some initial step size</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">t0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t_end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Take a step</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y_step</span><span class="p">,</span> <span class="n">error_step</span> <span class="o">=</span> <span class="n">rk45_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y_step</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_step</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Update step size after step</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">tol</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">**</span> <span class="mf">0.2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># accept step</span>
</span></span><span class="line"><span class="cl">            <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="ow">not</span> <span class="n">isStepGood</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># If there was too much error...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Take a step</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="c1"># update our time value with the new step size</span>
</span></span><span class="line"><span class="cl">            <span class="n">y_step</span><span class="p">,</span> <span class="n">error_step</span> <span class="o">=</span> <span class="n">rk45_step</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_step</span>
</span></span><span class="line"><span class="cl">            <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_step</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Update step size after step</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">tol</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">**</span> <span class="mf">0.2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Check error to accept or reject the step</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">isStepGood</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define orbit parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">mu</span> <span class="o">=</span> <span class="mf">398600.4415</span>
</span></span><span class="line"><span class="cl"><span class="n">rp</span> <span class="o">=</span> <span class="mi">6678</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="mf">0.9</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span> <span class="o">=</span> <span class="n">rp</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">T</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="n">mu</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define simulation parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">mu</span><span class="o">/</span><span class="n">rp</span> <span class="o">-</span> <span class="n">mu</span><span class="o">/</span><span class="n">a</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl"><span class="n">t_end</span> <span class="o">=</span> <span class="n">T</span>
</span></span><span class="line"><span class="cl"><span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-12</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Numerically integrate</span>
</span></span><span class="line"><span class="cl"><span class="n">t_rk45</span><span class="p">,</span> <span class="n">y_rk45</span><span class="p">,</span> <span class="n">local_error</span> <span class="o">=</span> <span class="n">rk45_solver</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">y_rk45</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_rk45</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plotting</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_rk45</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_rk45</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="c1"># dot for Earth</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Satellite Orbit Around Earth&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y [km]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x [km]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rk45</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y_rk45</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y_rk45</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Satellite Velocity&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;velocity [km/s]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t [s]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</details></p>

<p>The adaptive step size is able to deal with velocity changing by orders of magnitude. With a constant step size, we would be wasting a huge amount of computation on the far side of the orbit. The accuracy of the RK45 method also allows us to use very small tolerances (1e-12) and still have the computation time be relatively quick.</p>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>This guide should serve as a single comprehensive reference for what the RK45 method is, how it is derived, and how and why we use it to solve engineering problems. There is still room to improve on the ideas and code that have been shown here (the code lacks a lot of polish and dealing with edge cases for example).</p>
<p>However, for those like me who wanted to understand where this method comes from and why it is so good, I hope this has been a useful reference. The goal was to make these quite dense mathematical concepts as clear as possible for other engineers like me.</p>
<h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<p>[1] <a href="https://ntrs.nasa.gov/api/citations/19680000653/downloads/19680000653.pdf">Roson J. S., &ldquo;The Runge-Kutta Equations by Quadrature Methods&rdquo;, 1967, <em>NASA</em>.</a></p>
<p>[2] <a href="https://web.mit.edu/10.001/Web/Course_Notes/Differential_Equations_Notes/node5.html">&ldquo;Runge-Kutta Methods&rdquo;, <em>10.001: Numerical Solution of Ordinary Differential Equations</em></a></p>
<p>[3] <a href="https://math.stackexchange.com/questions/528856/explanation-and-proof-of-the-4th-order-runge-kutta-method">Explanation and proof of the 4th order Runge-Kutta method</a></p>
<p>[4] <a href="https://people.computing.clemson.edu/~dhouse/courses/817/papers/adaptive-h-c16-2.pdf">Numerical Recipes in C: The Art of Scientific Computing</a></p>
<p>[5] <a href="https://math.libretexts.org/Bookshelves/Differential_Equations/Numerically_Solving_Ordinary_Differential_Equations_(Brorson)/01%3A_Chapters/1.05%3A_Adaptive_stepping">S. Brorson, &ldquo;Numerically Solving Ordinary Differential Equations&rdquo;</a></p>
<p>[6] <a href="https://www.youtube.com/watch?v=6bCBXvsD7gw">Adaptive Runge-Kutta Methods | Lecture 54 | Numerical Methods for Engineers</a></p>
<p>[7] <a href="https://core.ac.uk/download/pdf/81989096.pdf">Dormand, J. R. and P. J. Prince, “A family of embedded Runge-Kutta formulae,” J. Comp. Appl. Math., Vol. 6, 1980, pp. 19–26.</a></p>
<p>[8] <a href="https://numerary.readthedocs.io/en/latest/dormand-prince-method.html">Dormand-Prince Method</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/blog/tags/runge-kutta/">Runge Kutta</a></li>
      <li><a href="http://localhost:1313/blog/tags/ode/">Ode</a></li>
      <li><a href="http://localhost:1313/blog/tags/numerical-integration/">Numerical Integration</a></li>
      <li><a href="http://localhost:1313/blog/tags/rk45/">Rk45</a></li>
      <li><a href="http://localhost:1313/blog/tags/python/">Python</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/blog/posts/conditionedfrequencyresponses/conditionedfrequencyresponses/">
    <span class="title">« Prev</span>
    <br>
    <span>Conditioned Frequency Responses</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share An Engineer&#39;s Guide to the Runge-Kutta (RK45) Method on x"
            href="https://x.com/intent/tweet/?text=An%20Engineer%27s%20Guide%20to%20the%20Runge-Kutta%20%28RK45%29%20Method&amp;url=http%3a%2f%2flocalhost%3a1313%2fblog%2fposts%2frk45%2frk45%2f&amp;hashtags=rungekutta%2code%2cnumericalintegration%2crk45%2cpython">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share An Engineer&#39;s Guide to the Runge-Kutta (RK45) Method on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fblog%2fposts%2frk45%2frk45%2f&amp;title=An%20Engineer%27s%20Guide%20to%20the%20Runge-Kutta%20%28RK45%29%20Method&amp;summary=An%20Engineer%27s%20Guide%20to%20the%20Runge-Kutta%20%28RK45%29%20Method&amp;source=http%3a%2f%2flocalhost%3a1313%2fblog%2fposts%2frk45%2frk45%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share An Engineer&#39;s Guide to the Runge-Kutta (RK45) Method on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fblog%2fposts%2frk45%2frk45%2f&title=An%20Engineer%27s%20Guide%20to%20the%20Runge-Kutta%20%28RK45%29%20Method">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share An Engineer&#39;s Guide to the Runge-Kutta (RK45) Method on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fblog%2fposts%2frk45%2frk45%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share An Engineer&#39;s Guide to the Runge-Kutta (RK45) Method on whatsapp"
            href="https://api.whatsapp.com/send?text=An%20Engineer%27s%20Guide%20to%20the%20Runge-Kutta%20%28RK45%29%20Method%20-%20http%3a%2f%2flocalhost%3a1313%2fblog%2fposts%2frk45%2frk45%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share An Engineer&#39;s Guide to the Runge-Kutta (RK45) Method on telegram"
            href="https://telegram.me/share/url?text=An%20Engineer%27s%20Guide%20to%20the%20Runge-Kutta%20%28RK45%29%20Method&amp;url=http%3a%2f%2flocalhost%3a1313%2fblog%2fposts%2frk45%2frk45%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share An Engineer&#39;s Guide to the Runge-Kutta (RK45) Method on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=An%20Engineer%27s%20Guide%20to%20the%20Runge-Kutta%20%28RK45%29%20Method&u=http%3a%2f%2flocalhost%3a1313%2fblog%2fposts%2frk45%2frk45%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/blog/">simmeon&#39;s blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
